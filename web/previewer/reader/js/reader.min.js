/*
 *	Copyright 2014 Leuphana Universität Lüneburg. All rights reserved.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *  http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/* @author Jens-Martin Loebel */
function HIReader(){this.version='v3.0.3.alpha';this.productID='Static Reader';this.xmlserializer=new XMLSerializer();this.prefs=new Object();this.strings=new Object();this.strings.length=0;this.load=null;this.viewID=null;this.last=null;this.fromLayer=null;this.allLayers=false;this.fromSearch=false;this.mode='regular';this.path=null;this.start=null;this.table=null;this.canvas=new Object();this.search=new Object();this.search.data=new Object();this.search.term=null;this.search.resultTerms=new Array();this.search.active=false;this.search.titles={text:"SEARCH_TEXT",text_title:"SEARCH_TEXT_TITLE",text_content:"SEARCH_TEXT_CONTENT",object:"SEARCH_OBJECT",object_inscription:"SEARCH_OBJECT_INSCRIPTION",view:"SEARCH_VIEW",view_title:"SEARCH_VIEW_TITLE",view_annotation:"SEARCH_VIEW_ANNOTATION",view_source:"SEARCH_VIEW_SOURCE",layer:"SEARCH_LAYER",layer_title:"SEARCH_LAYER_TITLE",layer_annotation:"SEARCH_LAYER_ANNOTATION",lita:"SEARCH_LITA",lita_title:"SEARCH_LITA_TITLE",lita_annotation:"SEARCH_LITA_ANNOTATION",url:"SEARCH_URL",url_title:"SEARCH_URL_TITLE",url_annotation:"SEARCH_LAYER_ANNOTATION",group:"SEARCH_GROUP",group_title:"SEARCH_GROUP_TITLE",group_annotation:"SEARCH_GROUP_ANNOTATION"};this.zoom=new Object();this.zoom.xOffset=330;this.zoom.yOffset=48;this.zoom.max=2.0;this.zoom.cur=0.0;this.zoom.image=0.0;this.zoom.window=0.0;this.zoom.full=1.0;this.zoom.min=0.0;this.project=new Object();this.project.id=null;this.project.items=new Object();this.project.title=new Object();this.project.texts=new Object();this.project.groups=new Object();this.project.litas=new Object();this.project.templates=new Object();this.project.langs=new Array();this.project.defaultLang=null;this.project.search=new Object();this.project.bookmarks=new Array();this.project.localLitas=new Array();this.project.items['imprint']=new HIText('imprint');}
reader=new HIReader();function HIObject(id,uuid){this.id=id;this.uuid=uuid;this.type="object";this.defaultViewID=null;this.md=new Object();this.views=new Object();this.siblings=new Object();}
function HIView(id,uuid){this.uuid=uuid;this.id=id;this.type="view";this.files=new Object();this.title=new Object();this.source=new Object();this.annotation=new Object();this.layers=new Object();this.sites=new Object();this.refs=new Object();this.parent=null;}
function HIInscription(id,uuid){this.id=id;this.type="inscription";this.content=new Object();this.sites=new Object();this.refs=new Object();this.parent=null;}
function HILayer(id,uuid){this.id=id;this.uuid=uuid;this.type="layer";this.color=null;this.opacity=1.0;this.ref=null;this.polygons=new Array();this.parent=null;this.title=new Object();this.annotation=new Object();}
function HIGroup(id,uuid){this.id=id;this.uuid=uuid;this.type="group";this.title=new Object();this.annotation=new Object();this.members=new Object();this.sites=new Object();this.refs=new Object();}
function HIContent(id,uuid){this.target=id;this.uuid=uuid;this.type=null;this.title=new Object();this.content=new Object();this.image=null;this.size=0;}
function HIFrame(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;this.href=null;this.imagePos=new Object();}
function HIFrameAnnotation(){this.x=14;this.y=64;this.width=200;this.height=200;this.annotation=new Object();this.visible=false;}
function HILighttable(id,uuid){this.id=id;this.uuid=uuid;this.type="lita";this.title=new Object();this.frames=new Array();this.frameAnnotation=new HIFrameAnnotation();this.sites=new Object();this.refs=new Object();}
function HIText(id,uuid){this.id=id;this.uuid=uuid;this.type="text";this.title=new Object();this.content=new Object();this.sites=new Object();this.refs=new Object();}
function HIURL(id,uuid){this.id=id;this.uuid=uuid;this.title=null;this.annotation=null;this.type="url";this.url=null;this.sites=new Object();}
function HIBookmark(id,title){this.id=id;this.title=title;}
var typeKeys={'group':"GRP_GROUP",'text':"GRP_TEXT",'lightTable':"GRP_LITA",'object':"GRP_OBJECT",'inscription':"GRP_INSCRIPTION",'view':"GRP_VIEW",'layer':"GRP_LAYER",'url':"GRP_URL"};var searchTypeKeys={'group':"SEARCH_RESULT_GROUP",'text':"SEARCH_RESULT_TEXT",'lita':"SEARCH_RESULT_LITA",'object':"SEARCH_RESULT_OBJECT",'inscription':"SEARCH_RESULT_INSCRIPTION",'view':"SEARCH_RESULT_VIEW",'layer':"SEARCH_RESULT_LAYER",'url':"GRP_URL"};;function loadPrefs(data,success){if(typeof(data)=='string')data=$.parseXML(data);prefs=data.getElementsByTagName("pref");for(prefID=0;prefID<prefs.length;prefID++){reader.prefs[prefs[prefID].getAttribute("key")]=prefs[prefID].getAttribute("val");}
$('#info').css("background-color",reader.prefs['INFOLINE_COLOR']);$('body').css("font-family",reader.prefs['MAINTEXT_FONT']);$('body').css("font-size",reader.prefs['MAINTEXT_SIZE']+'px');if(reader.prefs['MAINTEXT_BOLD']=='true')$.stylesheet('body').css('font-weight','bold');else $.stylesheet('body').css('font-weight','normal');if(reader.prefs['MAINTEXT_ITALIC']=='true')$.stylesheet('body').css('font-style','italic');else $.stylesheet('body').css('font-style','normal');if(reader.prefs['MAINTEXT_UNDERLINE']=='true')$.stylesheet('body').css('text-decoration','underline');else $.stylesheet('body').css('text-decoration','none');$.stylesheet('a').css("color",reader.prefs['MAINTEXT_LINK_COLOR']);$.stylesheet('a:visited').css("color",reader.prefs['MAINTEXT_LINK_COLOR']);if(reader.prefs['MAINTEXT_LINK_BOLD']=='true')$.stylesheet('a').css('font-weight','bold');else $.stylesheet('a').css('font-weight','normal');if(reader.prefs['MAINTEXT_LINK_ITALIC']=='true')$.stylesheet('a').css('font-style','italic');else $.stylesheet('a').css('font-style','normal');if(reader.prefs['MAINTEXT_LINK_UNDERLINE']=='true')$.stylesheet('a').css('text-decoration','underline');else $.stylesheet('a').css('text-decoration','none');$('body').css("background-color",reader.prefs['BG_COLOR']);$('#canvas').css("background-color",reader.prefs['BG_COLOR']);$('#groupView').css("background-color",reader.prefs['BG_COLOR']);$('#textView').css("background-color",reader.prefs['BG_COLOR']);$('#searchContent').css("background-color",reader.prefs['BG_COLOR']);$('#searchOptionsContent').css("background-color",reader.prefs['BG_COLOR']);$('#searchResultsContent').css("background-color",reader.prefs['BG_COLOR']);$('#metadataBar').css("background-color",reader.prefs['BG_COLOR']);$('#annotationBar').css("background-color",reader.prefs['BG_COLOR']);$('#inscriptionBar').css("background-color",reader.prefs['BG_COLOR']);$('#searchBar').css("background-color",reader.prefs['BG_COLOR']);$('#info').css("color",reader.prefs['MAINTEXT_COLOR']);$('body').css("color",reader.prefs['MAINTEXT_COLOR']);$.stylesheet('body, #info, #canvas, #groupView, #textView, #lighttableView, #sidebar, #metadataContent, #annotationContent, #inscriptionBar, #searchBar, .mdvalue, a, a:visited, ul.tabmenu li a').css('color',reader.prefs['MAINTEXT_COLOR']);$('#canvas').css("color",reader.prefs['MAINTEXT_COLOR']);$('#groupView').css("color",reader.prefs['MAINTEXT_COLOR']);$('#textView').css("color",reader.prefs['MAINTEXT_COLOR']);$('#lighttableView').css("color",reader.prefs['MAINTEXT_COLOR']);$('#sidebar').css("color",reader.prefs['MAINTEXT_COLOR']);$('#metadataContent').css("color",reader.prefs['MAINTEXT_COLOR']);$('#annotationContent').css("color",reader.prefs['MAINTEXT_COLOR']);$('#inscriptionBar').css("color",reader.prefs['MAINTEXT_COLOR']);$('#searchBar').css("color",reader.prefs['MAINTEXT_COLOR']);$.stylesheet('.mdvalue').css("color",reader.prefs['MENUTEXT_COLOR']);$('#textContent').css("max-width",reader.prefs['TEXT_WIDTH']+"px");if(reader.prefs['VIEW_SHOW_LAYER']==null)reader.prefs['VIEW_SHOW_LAYER']=false;if(reader.prefs['INFOLINE_METADATA_NUM']==null)reader.prefs['INFOLINE_METADATA_NUM']=1;else reader.prefs['INFOLINE_METADATA_NUM']=parseInt(reader.prefs['INFOLINE_METADATA_NUM']);if(reader.prefs['INFOLINE_METADATA_VIEW']==null)reader.prefs['INFOLINE_METADATA_VIEW']=false;if(reader.prefs['INFOLINE_METADATA_VIEW']=='true')reader.prefs['INFOLINE_METADATA_VIEW']=true;else reader.prefs['INFOLINE_METADATA_VIEW']=false;$('#mainmenu').css("color",reader.prefs['MENUTEXT_COLOR']);$.stylesheet('ul.mainmenu a').css("color",reader.prefs['MENUTEXT_COLOR']);$.stylesheet('#mainmenu, ul.mainmenu a').css("color",reader.prefs['MENUTEXT_COLOR']);if(reader.prefs['MENUTEXT_BOLD']=='true')$.stylesheet('#mainmenu, ul.mainmenu a').css('font-weight','bold');else $.stylesheet('#mainmenu, ul.mainmenu a').css('font-weight','normal');if(reader.prefs['MENUTEXT_ITALIC']=='true')$.stylesheet('#mainmenu, ul.mainmenu a').css('font-style','italic');else $.stylesheet('#mainmenu, ul.mainmenu a').css('font-style','normal');if(reader.prefs['MENUTEXT_UNDERLINE']=='true')$.stylesheet('#mainmenu, ul.mainmenu a').css('text-decoration','underline');else $.stylesheet('#mainmenu, ul.mainmenu a').css('text-decoration','none');$.stylesheet('#mainmenu, ul.mainmenu a').css("letter-spacing",reader.prefs['MENUTEXT_LETTERSPACING']+'px');$('#mainmenu').css("background-color",reader.prefs['MENU_COLOR']);$.stylesheet('.disabled').css('background-color',reader.prefs['MENU_COLOR']+' !important');$.stylesheet('.disabled > a').css('background-color',reader.prefs['MENU_COLOR']+' !important');$.stylesheet('ul.mainmenu li.separator:hover').css("background-color",reader.prefs['MENU_COLOR']+' !important');$.stylesheet('ul.mainmenu ul').css("background-color",reader.prefs['MENU_COLOR']);$('#mainmenu').css("font-family",reader.prefs['MENUTEXT_FONT']);$('#mainmenu').css("font-size",reader.prefs['MENUTEXT_SIZE']+'px');$.stylesheet('ul.mainmenu li:hover').css('background-color',reader.prefs['MENU_COLOR_HI']);$.stylesheet('.disabled').css('color',reader.prefs['MENUTEXT_COLOR_DEACT']+' !important');$.stylesheet('.disabled > a').css('color',reader.prefs['MENUTEXT_COLOR_DEACT']+' !important');$.stylesheet('ul.tabmenu li.selected').css('background-color',reader.prefs['TABS_COLOR']);$('#tabs').css('background-color',reader.prefs['TABS_COLOR_DESEL']);$('ul.tabmenu li').css('border-right-color',reader.prefs['TABS_COLOR_BORDER']);$.stylesheet('ul.tabmenu li a').css('color',reader.prefs['MAINTEXT_COLOR']);if(reader.prefs['TABTITLE_BOLD']=='true')$.stylesheet('.mdkey').css('font-weight','bold');else $.stylesheet('.mdkey').css('font-weight','normal');if(reader.prefs['TABTITLE_ITALIC']=='true')$.stylesheet('.mdkey').css('font-style','italic');else $.stylesheet('.mdkey').css('font-style','normal');if(reader.prefs['TABTITLE_UNDERLINE']=='true')$.stylesheet('.mdkey').css('text-decoration','underline');else $.stylesheet('.mdkey').css('text-decoration','none');$.stylesheet('.mdkey').css('font-family',reader.prefs['TABTITLE_FONT']);$.stylesheet('.mdkey').css('font-size',reader.prefs['TABTITLE_SIZE']+'px');$.stylesheet('.mdkey').css('color',reader.prefs['TABTITLE_COLOR']);showTab(reader.prefs['TABS_STANDARD']);$.stylesheet('#searchOptionsList, #searchOptionsList ul').css("font-family",reader.prefs['SEARCH_ITEM_FONT']);$.stylesheet('#searchOptionsList, #searchOptionsList ul').css("font-size",reader.prefs['SEARCH_ITEM_SIZE']+'px');$.stylesheet('#searchOptionsList, #searchOptionsList ul').css("color",reader.prefs['SEARCH_ITEM_COLOR']);if(reader.prefs['SEARCH_ITEM_BOLD']=='true')$.stylesheet('#searchOptionsList, #searchOptionsList ul').css('font-weight','bold');else $.stylesheet('#searchOptionsList, #searchOptionsList ul').css('font-weight','normal');if(reader.prefs['SEARCH_ITEM_ITALIC']=='true')$.stylesheet('#searchOptionsList, #searchOptionsList ul').css('font-style','italic');else $.stylesheet('#searchOptionsList, #searchOptionsList ul').css('font-style','normal');if(reader.prefs['SEARCH_ITEM_UNDERLINE']=='true')$.stylesheet('#searchOptionsList, #searchOptionsList ul').css('text-decoration','underline');else $.stylesheet('#searchOptionsList, #searchOptionsList ul').css('text-decoration','none');$.stylesheet('#searchOptionsList, #searchOptionsList ul').css("letter-spacing",reader.prefs['SEARCH_ITEM_LETTERSPACING']+'px');var tooltipStyle=$.stylesheet('.tooltip');var tooltipBGStyle=$.stylesheet('.tooltipBackground');var tooltipFGStyle=$.stylesheet('.tooltipContent');tooltipBGStyle.css('background-color',reader.prefs['TOOLTIP_COLOR']);tooltipBGStyle.css('opacity',parseFloat(reader.prefs['OVERLAYS_OPACITY']));tooltipStyle.css('width',reader.prefs['TOOLTIP_WIDTH']+"px");tooltipStyle.css('max-width',reader.prefs['TOOLTIP_WIDTH']+"px");tooltipFGStyle.css('font-family',reader.prefs['TOOLTIPTEXT_FONT']);tooltipFGStyle.css('font-size',reader.prefs['TOOLTIPTEXT_SIZE']+"px");tooltipFGStyle.css('color',reader.prefs['TOOLTIPTEXT_COLOR']);if(reader.prefs['TOOLTIPTEXT_BOLD']=='true')tooltipFGStyle.css('font-weight','bold');else tooltipFGStyle.css('font-weight','normal');if(reader.prefs['TOOLTIPTEXT_ITALIC']=='true')tooltipFGStyle.css('font-style','italic');else tooltipFGStyle.css('font-style','normal');if(reader.prefs['TOOLTIPTEXT_UNDERLINE']=='true')tooltipFGStyle.css('text-decoration','underline');else tooltipFGStyle.css('text-decoration','none');tooltipFGStyle.css("letter-spacing",reader.prefs['TOOLTIPTEXT_LETTERSPACING']+'px');$.stylesheet('#groupList li.text').css("background-color",reader.prefs['GROUPMEMBER_COLOR']);$.stylesheet('#groupList li.text').css("border-color",reader.prefs['GROUPMEMBER_COLOR_BORDER']);$.stylesheet('#groupList li.text a').css("color",reader.prefs['GROUP_THUMB_COLOR']);$.stylesheet('#groupList li.text a').css("font-family",reader.prefs['GROUP_THUMB_FONT']);$.stylesheet('#groupList li.text a').css("font-size",reader.prefs['GROUP_THUMB_SIZE']+'px');if(reader.prefs['GROUP_THUMB_BOLD']=='true')$.stylesheet('#groupList li.text a').css('font-weight','bold');else $.stylesheet('#groupList li.text a').css('font-weight','normal');if(reader.prefs['GROUP_THUMB_ITALIC']=='true')$.stylesheet('#groupList li.text a').css('font-style','italic');else $.stylesheet('#groupList li.text a').css('font-style','normal');if(reader.prefs['GROUP_THUMB_UNDERLINE']=='true')$.stylesheet('#groupList li.text a').css('text-decoration','underline');else $.stylesheet('#groupList li.text a').css('text-decoration','none');$.stylesheet('#groupList li.text a').css("letter-spacing",reader.prefs['GROUP_THUMB_LETTERSPACING']+'px');$('#lighttableView').css("background-color",reader.prefs['LITA_COLOR_BG']);$.stylesheet('.ltFrameTitle').css("background-color",reader.prefs['LITA_COLOR_HEAD']);$.stylesheet('.ltSelected .ltFrameTitle').css("background-color",reader.prefs['LITA_COLOR_HEADSEL']);$.stylesheet('.ltFrameTitle').css("font-family",reader.prefs['LITA_HEAD_FONT']);$.stylesheet('.ltFrameTitle').css("font-size",reader.prefs['LITA_HEAD_SIZE']+'px');$.stylesheet('.ltFrameTitle').css("color",reader.prefs['LITA_HEAD_COLOR']);$.stylesheet('.ltAnnotation .ltText').css("font-family",reader.prefs['LITA_ANN_FONT']);$.stylesheet('.ltAnnotation .ltText').css("font-size",reader.prefs['LITA_ANN_SIZE']+'px');$.stylesheet('.ltAnnotation .ltText').css("color",reader.prefs['LITA_ANN_COLOR']);$.stylesheet('.hiButton').css("font-family",reader.prefs['DIALOGTEXT_FONT']);$('#searchInput').css("font-family",reader.prefs['DIALOGTEXT_FONT']);$.stylesheet('.hiButton').css("font-size",reader.prefs['DIALOGTEXT_SIZE']+'px');$('#searchInput').css("font-size",reader.prefs['DIALOGTEXT_SIZE']+'px');$.stylesheet('.hiButton').css("color",reader.prefs['DIALOGTEXT_COLOR']);$('#searchInput').css("color",reader.prefs['DIALOGTEXT_COLOR']);$.stylesheet('.hiButton').css("background-color",reader.prefs['DIALOG_BUTTON_COLOR']);$('#searchInput').css("background-color",reader.prefs['DIALOG_INPUT_COLOR']);}
function loadStrings(data,success){if(typeof(data)=='string')data=$.parseXML(data);langs=data.getElementsByTagName("table");for(var langID=0;langID<langs.length;langID++){var lang=langs[langID].getAttribute("xml:lang");reader.strings[lang]=new Object();reader.strings[lang]['VERSION']=reader.version;reader.strings.length++;var strings=langs[langID].getElementsByTagName("str");for(var stringID=0;stringID<strings.length;stringID++)
reader.strings[lang][strings[stringID].getAttribute("key")]=strings[stringID].firstChild.nodeValue;}}
function loadStartFile(data,success){if(typeof(data)=='string')data=$.parseXML(data);reader.path=data.getElementsByTagName("project")[0].getAttribute("path");reader.project.id=data.getElementsByTagName("link")[0].getAttribute("ref");}
function loadProjectFile(data,success){if(typeof(data)=='string')data=$.parseXML(data);langs=data.getElementsByTagName("language");if(langs.length<1)reportError("No project languages found or load error ("+reader.project.id+".xml)");for(i=0;i<langs.length;i++){reader.project.langs[i]=langs[i].firstChild.nodeValue;if(langs[i].getAttribute("standard")=='true')reader.project.defaultLang=reader.project.langs[i];}
if(reader.project.defaultLang==null||reader.project.defaultLang.length==0)
reader.project.defaultLang=reader.project.langs[0];titles=data.getElementsByTagName("title");for(i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)
reader.project.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else reader.project.title[titles[i].getAttribute("xml:lang")]='';reader.start=data.getElementsByTagName("link")[0].getAttribute("ref");templates=data.getElementsByTagName("template");sortedFields=new Array();var htmlFields="";for(i=0;i<templates.length;i++){var templateID=templates[i].getAttribute("id");keys=templates[i].getElementsByTagName("key");for(keyID=0;keyID<keys.length;keyID++){sortedFields[keys[keyID].getAttribute("rank")-1]=templateID+"_"+keys[keyID].getAttribute("tagName");var tempKey=reader.project.templates[templateID+"_"+keys[keyID].getAttribute("tagName")]=new Object();tempKey.key=keys[keyID].getAttribute("tagName");tempKey.template=templateID;if(keys[keyID].getAttribute("richText")=="true")tempKey.richText=true;else tempKey.richText=false;tempLangs=keys[keyID].getElementsByTagName("displayName");for(langID=0;langID<tempLangs.length;langID++){if(tempLangs[langID].firstChild!=null)
tempKey[tempLangs[langID].getAttribute("xml:lang")]=tempLangs[langID].firstChild.nodeValue;else tempKey[tempLangs[langID].getAttribute("xml:lang")]='x';}}}
reader.project.sortedFields=sortedFields;reader.project.search.files=new Object();var files=data.getElementsByTagName("index");for(i=0;i<files.length;i++)
reader.project.search.files[files[i].getAttribute("xml:lang")]=files[i].getElementsByTagName("file")[0].firstChild.nodeValue;var menus=data.getElementsByTagName("menu");for(i=0;i<menus.length;i++){if(menus[i].getAttribute("key")=="text")entries=reader.project.texts;else if(menus[i].getAttribute("key")=="group")entries=reader.project.groups;else entries=reader.project.litas;var lang=menus[i].getAttribute("xml:lang");items=menus[i].getElementsByTagName("item");for(itemID=0;itemID<items.length;itemID++){if(entries[items[itemID].getAttribute("ref")]==null)entries[items[itemID].getAttribute("ref")]=new Object();if(items[itemID].firstChild)entries[items[itemID].getAttribute("ref")][lang]=items[itemID].firstChild.nodeValue;else entries[items[itemID].getAttribute("ref")][lang]='';}}}
function addSearchSection(lang,head){var section=new Object();if(reader.search.titles[head.getAttribute("key")]!=null&&reader.strings[lang]!=null&&reader.strings[lang][reader.search.titles[head.getAttribute("key")]]!=null)
section.title=reader.strings[lang][reader.search.titles[head.getAttribute("key")]];else section.title=head.getAttribute("key");if(head.getAttribute('caption')!=null)section.title=head.getAttribute('caption');section.key=head.getAttribute("key");section.items=new Array();section.substitute=head.getAttribute('substitute')!=null?parseInt(head.getAttribute('substitute')):null;$(head).find('> item').each(function(index,item){section.items.push(addSearchSection(lang,item));});return section;}
function displaySection(section){var list='';list+="<li id=\""+section.key+"\"";if(section.items.length!=0)list+=' class="hiBold"';list+=">\n";list+="<input id=\""+section.key+"_check\" type=\"checkbox\" checked=\"checke\" class=\"searchSection\" />\n";list+="<label for=\""+section.key+"_check\" ";list+=">"+section.title+"</label>\n";list+="</li>\n";if(section.items.length>0){list+="<ul id=\""+section.key+"_section\" >\n";$(section.items).each(function(index,item){list+=displaySection(item);});list+="<ul>\n";}
return list;}
function searchAllHandler(ev){var isChecked=$(this).is(':checked');$('#searchOptionsList').find('input').prop('checked',isChecked);}
function searchSectionHandler(ev){var list=$(this).parent().parent();var isChecked=$(this).is(':checked');if($(this).parent().hasClass('hiBold'))
$(this).parent().next().find('input').prop('checked',isChecked);do{var box=$(list.prev()).find('> input:first');if(!isChecked)box.prop('checked',false);else{var allSelected=true;list.find('input').each(function(index,section){if(!$(section).is(':checked'))allSelected=false;});if(allSelected)box.prop('checked',"checked");}
list=list.parent();}while(list.attr('id')!='searchOptionsList');}
function fillSearchSections(lang){$('#searchSectionsList').empty();$(reader.project.search[lang].sections).each(function(index,section){$('#searchSectionsList').append(displaySection(section));});$('#searchSectionsList input').change(searchSectionHandler);}
function loadSearchFile(fileLang,success){var data=reader.search.data[fileLang];if(typeof(data)=='string')data=$.parseXML(data);var lang=data.getElementsByTagName('index')[0].getAttribute('xml:lang');if(lang==null||lang.length==0)reportError('no language index found in XML file "index_'+fileLang+'"');reader.project.search[lang]=new Object();reader.project.search[lang].entries=new Object();var subsByNumber=new Array();var subsByKey=new Object();var subItems=data.getElementsByTagName('item');$(subItems).each(function(index,item){if(item.getAttribute('substitute')!=null){subsByNumber[parseInt(item.getAttribute('substitute'))]=item.getAttribute('key');subsByKey[item.getAttribute('key')]=parseInt(item.getAttribute('substitute'));}});$(data).find('entry').each(function(index,entry){var id=entry.getAttribute('str');reader.project.search[lang].entries[id]=new Object();$(entry).find('rec').each(function(index,rec){var ref=rec.getAttribute('ref');reader.project.search[lang].entries[id][ref]=new Array();$(rec.getAttribute('key').split(',')).each(function(index,key){reader.project.search[lang].entries[id][ref].push(parseInt(key));});});});reader.project.search[lang].subByNumber=subsByNumber;reader.project.search[lang].subByKey=subsByKey;reader.project.search[lang].sections=new Array();$(data).find('index > item').each(function(index,item){reader.project.search[lang].sections.push(addSearchSection(lang,item));});if(fileLang==reader.lang)fillSearchSections(reader.lang);reader.search.data[fileLang]=null;if(reader.lang==fileLang&&reader.search.active==true)performSearch();console.log("search: "+fileLang);}
function setLanguage(lang){if(reader.strings.length<1)reportError("no on-screen languages found or load error for \""+lang+"\"");if(reader.strings[lang]==null){var fallbacklang=reader.strings[reader.project.defaultLang];if(fallbacklang==null)fallbacklang=reader.strings['en'];reader.strings[lang]=fallbacklang;}
for(i=0;i<reader.project.langs.length;i++)
setMenuItem('setLang_'+reader.project.langs[i],"javascript:setLanguage(\'"+reader.project.langs[i]+"\');",(reader.project.langs[i]!=lang));for(key in reader.strings[lang]){var elements=$("."+key);$.each(elements,function(index,element){$(element).contents().each(function(){if(this.nodeType===3){this.nodeValue=reader.strings[lang][key];return false;}});});}
for(i=0;i<reader.project.sortedFields.length;i++)
$('#'+reader.project.sortedFields[i]+"_key").text(reader.project.templates[reader.project.sortedFields[i]][lang]);for(group in reader.project.groups)
$('.'+group+"_menuitem").text(reader.project.groups[group][lang]);for(text in reader.project.texts)
$('.'+text+"_menuitem").text(reader.project.texts[text][lang]);for(lita in reader.project.litas)
$('.'+lita+"_menuitem").text(reader.project.litas[lita][lang]);$('#searchButton').attr('value',reader.strings[lang]['SEARCH_SEARCH']);$('#basicSearchButton').attr('value',reader.strings[lang]['SEARCH_BASIC']);$('#extendedSearchButton').attr('value',reader.strings[lang]['SEARCH_ADVANCED']);if(reader.project.search[lang]!=null)fillSearchSections(lang);document.title=(reader.project.title[reader.project.defaultLang]+" - HyperImage 3 ("+reader.productID+" "+reader.version+")");reader.lang=lang;if(reader.load!=null)setGUI(true);}
function loadHandler(e){var newhash=location.hash.substring(1);e.preventDefault();var mode='regular';if(newhash.split('/').length>1&&newhash.split('/')[1].length>0)
mode=newhash.split('/')[1];newhash=newhash.split('/')[0];var newmode=false;if(mode!='regular'&&mode!='all'&&mode!='refs'&&mode!='sites')mode='regular';if(mode!=reader.mode){reader.mode=mode;newmode=true;}
if(newhash.length==0)location.hash=reader.start;else if(newhash!=reader.load)loadItem(newhash,false,true);else if(newmode)setGUI();}
function restoreSession(){try{if(window.localStorage!=null){var bookmarkString=window.localStorage["bookmarks_"+reader.project.id+"_"+location.host+location.pathname];var bookmarks;if(bookmarkString!=null)bookmarks=JSON.parse(bookmarkString);if(bookmarks!=null)reader.project.bookmarks=bookmarks;var tableString=window.localStorage["lighttables_"+reader.project.id+"_"+location.host+location.pathname];var tables;if(tableString!=null)tables=JSON.parse(tableString);if(tables!=null)reader.project.localLitas=tables;}}catch(e){console.log("restore error: ",e);}}
function setImageLoadingIndicator(showIndicator){if(showIndicator)$('#imageLoadingIndicator').css("display","block");else $('#imageLoadingIndicator').css("display","none");}
function setLoadingIndicator(showIndicator){if(showIndicator)$('#loadingIndicator').css("display","block");else $('#loadingIndicator').css("display","none");}
function initContextMenus(){$(reader.canvas.layerGroup).contextMenu({zIndex:1000,selector:'[id$=_group]',callback:function(key,options){var layerID=$(this).attr('id');layerID=layerID.substring(0,layerID.length-6);switch(key){case'addLayerToLita':addLayerToLightTable(layerID);break;case'sitesOfLayer':location.hash=layerID+'/sites';break;case'refsOfLayer':location.hash=layerID+'/refs';break;}},items:{addLayerToLita:{name:"<span class='MENU_LAYER_TO_LITA'>&nbsp;</span>"},separator1:"-----",sitesOfLayer:{name:"<span class='MENU_SITES_LAYER'>&nbsp;</span>"},refsOfLayer:{name:"<span class='MENU_REFS_LAYER'>&nbsp;</span>"}}});$.contextMenu({zIndex:1000,selector:'#canvasImage',callback:function(key,options){switch(key){case'addViewToLita':addViewToLightTable();break;case'sitesOfView':location.hash=reader.viewID+'/sites';break;case'refsOfView':location.hash=reader.viewID+'/refs';break;}},items:{addViewToLita:{name:"<span class='MENU_VIEW_TO_LITA'>&nbsp;</span>"},separator1:"-----",sitesOfView:{name:"<span class='MENU_SITES_VIEW'>&nbsp;</span>"},refsOfView:{name:"<span class='MENU_REFS_VIEW'>&nbsp;</span>"}}});$.contextMenu({zIndex:1000,selector:'.hasContentsContextMenu',callback:function(key,options){var contentID=$(this).attr('id').substring(3);var type=$(this).data('contentType');switch(type){case'layer':var layer=reader.project.items[contentID];if(layer==null){$.ajax({url:reader.path+contentID+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');var viewID=$(xmlData).find('view').attr('id');$.ajax({url:reader.path+viewID+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');}
setLoadingIndicator(false);addLayerToLightTable(contentID);break;case'view':var view=reader.project.items[contentID];if(view==null){$.ajax({url:reader.path+contentID+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');view=reader.project.items[contentID];}
setLoadingIndicator(false);addViewToLightTable(view.id);break;case'object':var object=reader.project.items[contentID];if(object==null){$.ajax({url:reader.path+contentID+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');object=reader.project.items[contentID];}
var view=reader.project.items[object.defaultViewID];if(view==null){$.ajax({url:reader.path+object.defaultViewID+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');view=reader.project.items[object.defaultViewID];}
setLoadingIndicator(false);addViewToLightTable(object.defaultViewID);break;}},items:{addToLita:{name:"<span class='MENU_SEND_TO_LITA'>&nbsp;</span>"}}});$.contextMenu({zIndex:1000,selector:'.hasLitaContextMenu',callback:function(key,options){switch(key){case'showInBrowser':var viewID=$(this).data('viewID');if(viewID!=null)location.hash=viewID+'/';break;case'fitFrame':fitToFrame();break;case'fitToThumb':fitToThumb();break;case'duplicateFrame':duplicateFrame();break;case'removeFrame':removeFrame();break;}},items:{showInBrowser:{name:"<span class='MENULITA_BROWSER'>&nbsp;</span>"},separator1:"-----",fitFrame:{name:"<span class='MENULITA_FIT_FRAME'>&nbsp;</span>"},fitToThumb:{name:"<span class='MENULITA_THUMBNAIL'>&nbsp;</span>"},duplicateFrame:{name:"<span class='MENULITA_DUPLICATE_ELEMENT'>&nbsp;</span>"},separator2:"-----",removeFrame:{name:"<span class='MENULITA_DELETE_ELEMENT'>&nbsp;</span>"}},events:{show:function(opt){$(this).trigger('click');},hide:function(opt){$(this).trigger('click');}}});}
function initGUI(){jQuery('ul.mainmenu').superfish({hoverClass:'sfHover',delay:0,animation:{opacity:'show'},animationOut:{opacity:'hide'},speed:0,speedOut:0,});$('ul.mainmenu').click(function(e){$('ul.mainmenu').hideSuperfishUl();});var mdDIV=document.getElementById("metadataBar");var tempHTML="";for(i=1;i<reader.project.sortedFields.length;i++){tempHTML+='<div id="'+reader.project.sortedFields[i]+'_field" class="mdfield">\n';tempHTML+='  <div id="'+reader.project.sortedFields[i]+'_key" class="mdkey">&nbsp;</div>\n';tempHTML+='  <div id="'+reader.project.sortedFields[i]+'_value" class="mdvalue">&nbsp;</div>\n';tempHTML+='</div>\n';}
tempHTML+='<div id="viewtitle_field" class="mdfield">\n';tempHTML+='  <div id="viewtitle_key" class="METADATA_TITLE_VIEW mdkey">&nbsp;</div>\n';tempHTML+='  <div id="viewtitle_value" class="mdvalue">&nbsp;</div>\n';tempHTML+='</div>\n';tempHTML+='<div id="viewsource_field" class="mdfield">\n';tempHTML+='  <div id="viewsource_key" class="METADATA_SOURCE_VIEW mdkey">&nbsp;</div>\n';tempHTML+='  <div id="viewsource_value" class="mdvalue">&nbsp;</div>\n';tempHTML+='</div>\n';mdDIV.innerHTML=tempHTML;$("a.startitem").each(function(index,item){item.href='#'+reader.start+"/";});var foundBookmarks=false;for(var i=0;i<reader.project.bookmarks.length;i++)
$('#bookmarkmenu').append('<li><a href="#'+reader.project.bookmarks[i].id+'/">'+reader.project.bookmarks[i].title+'</a></li>');if(reader.project.bookmarks.length>0)foundBookmarks=true;setMenuItem("deleteBookmarkLink","javascript:deleteBookmark();",foundBookmarks);setMenuItem("deleteAllBookmarksLink","javascript:deleteAllBookmarks();",foundBookmarks);var foundTables=false;for(var i=(reader.project.localLitas.length-1);i>=0;i--)
$('#localLightTables').after('<li><a href="javascript:loadLocalTable('+i+');">'+reader.project.localLitas[i].title[reader.project.defaultLang]+'</a></li>');if(reader.project.localLitas.length>0)foundTables=true;setMenuItem("deleteLocalTableLink","javascript:deleteLocalTable();",foundTables);for(var i=reader.project.langs.length-1;i>=0;i--)
if(reader.strings[reader.project.defaultLang]['MENU_LANG_'+reader.project.langs[i]]!=null)
$('#languageMenu').prepend('<li><a id="setLang_'+reader.project.langs[i]+'" href="javascript:setLanguage(\''+reader.project.langs[i]+'\');" class="'+'MENU_LANG_'+reader.project.langs[i]+'">&nbsp;</a></li>');else
$('#languageMenu').prepend('<li><a id="setLang_'+reader.project.langs[i]+'" href="javascript:setLanguage(\''+reader.project.langs[i]+'\');">'+reader.project.langs[i]+'</a></li>');tempHTML="";groupDIV=$("#groupmenu");textDIV=$("#textmenu");litaDIV=$("#publicLightTables");for(group in reader.project.groups)
groupDIV.append('<li><a class="'+group+'_menuitem" href="#'+group+'/">&nbsp;</a></li>');if(Object.keys(reader.project.groups).length==0)$('#groupmenu').parent().css("display","none");for(text in reader.project.texts)
textDIV.append('<li><a class="'+text+'_menuitem" href="#'+text+'/">&nbsp;</a></li>');if(Object.keys(reader.project.texts).length==0)$('#textmenu').parent().css("display","none");$(Object.keys(reader.project.litas).reverse()).each(function(index,lita){litaDIV.after('<li><a class="'+lita+'_menuitem" href="#'+lita+'/">&nbsp;</a></li>');});$('#canvas').svg();reader.canvas.svg=$('#canvas').svg('get');reader.canvas.svg.root().setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");reader.canvas.svg.root().setAttribute("xmlns:xhtml","http://www.w3.org/1999/xhtml");reader.canvas.imageGroup=reader.canvas.svg.group(reader.canvas.svg.root(),'canvasImageGroup',{});reader.canvas.image=reader.canvas.svg.image(reader.canvas.imageGroup,0,0,100,100,'#',{id:'canvasImage'});reader.canvas.layerGroup=reader.canvas.svg.group(reader.canvas.imageGroup,'canvasLayerGroup',{});$('#canvas').dragscrollable({acceptPropagatedEvent:true});$("#canvas").hover(function(ev){if(reader.zoom.cur>reader.zoom.image)$(ev.currentTarget).css('cursor','move');},function(ev){$(ev.currentTarget).css('cursor','default');});$(window).resize(function(e){calcImageScales();$('#sidebar').css('max-height',$(window).height()-reader.zoom.yOffset);$('#searchResults').css('max-height',$(window).height()-reader.zoom.yOffset-69);$('#searchOptions').css('max-height',$(window).height()-reader.zoom.yOffset-69);});$('#sidebar').css('max-height',$(window).height()-reader.zoom.yOffset);$('#searchResults').css('max-height',$(window).height()-reader.zoom.yOffset-69);$('#searchOptions').css('max-height',$(window).height()-reader.zoom.yOffset-69);var ev=$(window).bind('hashchange',loadHandler);$('#loadingIndicator').activity({segments:12,width:2,space:1,length:4,speed:1.2});$('#imageLoadingIndicator').activity({segments:12,width:9,space:6,length:20,speed:2.2});$('#basicSearchButton').click(function(e){$('#basicSearchButton').hide();$('#extendedSearchButton').show();$('#searchResults').show();$('#searchOptions').hide();});$('#extendedSearchButton').click(function(e){$('#basicSearchButton').show();$('#extendedSearchButton').hide();$('#searchResults').hide();$('#searchOptions').show();});$('#searchButton').click(function(e){performSearch();});$('#searchInput').keypress(function(e){if(e.which==13)performSearch();});$('#search_everything').change(searchAllHandler);}
function showTab(tab){$('ul.tabmenu li').each(function(index,item){if(index!=tab)$(item).removeClass('selected');else $(item).addClass('selected');});$('.sidebars').each(function(index,item){if(index==tab)$(item).removeClass('hidden');else $(item).addClass('hidden');});if(tab==2&&reader.load!=null&&reader.project.items[reader.load].type=='inscription')highlightSourceLayer();}
function initReader(){$('#guiInitIndicator').activity({segments:12,width:6,space:6,length:14,speed:1.2});$(window).mousemove(function(e){reader.pageX=e.pageX;reader.pageY=e.pageY;});$.ajax({url:'resource/hi_prefs.xml',dataType:'xml',success:function(data,success){loadPrefs(data,success);$.ajax({url:'resource/hi_strings.xml',dataType:'xml',success:function(data,success){loadStrings(data,success);$.ajax({url:reader.prefs['INITIAL_REF'],dataType:'xml',success:function(data,success){loadStartFile(data,success);$.ajax({url:reader.path+reader.project.id+'.xml',dataType:'xml',success:function(data,success){loadProjectFile(data,success);restoreSession();newLocalTable(false);initGUI();initContextMenus();setLanguage(reader.project.defaultLang);$(Object.keys(reader.project.search.files)).each(function(index,fileLang){$.get('postPetal/'+reader.project.search.files[fileLang],function(data,success){reader.search.data[fileLang]=data;window.setTimeout('loadSearchFile("'+fileLang+'", "+success+")',2000);});});var mode='regular';if(location.hash.substring(1).split('/').length>1&&location.hash.substring(1).split('/')[1].length>0)
mode=location.hash.substring(1).split('/')[1];if(mode!='regular'&&mode!='all'&&mode!='refs'&&mode!='sites')mode='regular';reader.mode=mode;if(location.hash.length>0)loadItem(location.hash.substring(1).split('/')[0],false,true);else location.hash=reader.start+"/";console.log(reader);},error:function(error){reportError('Required file "'+reader.path+reader.project.id+'.xml" missing or load error.')}});},error:function(error){reportError('Required file "'+reader.prefs['INITIAL_REF']+'" (pref key INITIAL_REF) missing or load error.')}});},error:function(error){reportError('Required file "resource/hi_strings.xml" missing or load error.')}});},error:function(error){reportError('Required file "resource/hi_prefs.xml" missing or load error.<br><br><strong>Did you start the Reader from your harddrive?</strong><br>For this online publication to work you need to upload your project to a web server.<br>An offline version is included in this package and available from our website.')}});};function reportError(error){$('#errorMessage').html(error);$("#errorDialog").dialog({draggable:false,resizable:false,closeOnEscape:false,dialogClass:'no-close',title:"HyperImage Reader Critical Error",width:550,height:200,modal:true,});throw new Error(error);}
function aboutReader(){$("#aboutDialog").dialog({draggable:false,resizable:false,title:reader.strings[reader.lang]['MENU_ABOUT'],width:550,height:415,modal:true,buttons:{"Learn more...":function(){location.href="http://hyperimage.ws/";},"OK":function(){$(this).dialog("close");}}});}
function getObject(item){if(item==null)return null;if(item.type=='object')return item;if(item.type=='view')return item.parent;if(item.type=='inscription')return item.parent;if(item.type=='layer')return item.parent.parent;return null;}
function parseImprint(data,success){reader.last=reader.load;reader.load='imprint';reader.project.items['imprint'].content[reader.lang]=data;setGUI();}
function loadItem(id,auxLoad,shouldSetGUI){var auxload=auxload;if(id=='imprint')if(reader.project.items['imprint'].content[reader.lang]==null){$.get('resource/imprint_'+reader.lang+'.txt',parseImprint);return;}
if(reader.load==id)return;if(!auxLoad){if(reader.project.items[reader.load]==null||reader.project.items[reader.load].type!='lita')reader.last=reader.load;reader.load=id;}
if(reader.project.items[id]==null){setLoadingIndicator(true);$.get(reader.path+id+'.xml',function(data,success){parseItem(data,success,shouldSetGUI);});}else{console.log(id+" - already in memory");setGUI();}}
function parseMDField(accessKey,field){if(field.firstChild==null)return'';if(accessKey!=''&&reader.project.templates[accessKey]==null)return'';if(accessKey==""||reader.project.templates[accessKey].richText==true){$(field).find('a').each(function(index,link){$(link).attr('onclick','javascript:checkExternalLink(this);');$(link).attr('class','HIExternalLink');});var htmlText=$(field).html();return htmlText;}else return field.firstChild.nodeValue;}
function collectContent(items){var contents=new Object();$(items).each(function(index,member){var content=new HIContent(member.getAttribute("ref"));content.type=member.getAttribute("petalType");$(member).find("title").each(function(i,title){if(title.firstChild!=null)content.title[title.getAttribute("xml:lang")]=title.firstChild.nodeValue;else content.title[title.getAttribute("xml:lang")]='';});if(content.type=='url'){if($(member).find("title")[0].firstChild!=null)content.title=$(member).find("title")[0].firstChild.nodeValue;else content.title='';}
$(member).find("meta").each(function(i,meta){if(meta.firstChild!=null)content.title[meta.getAttribute("xml:lang")]=meta.firstChild.nodeValue;else content.title[meta.getAttribute("xml:lang")]='';});$(member).find("content").each(function(i,ins){if(ins.firstChild!=null)content.content[ins.getAttribute("xml:lang")]=ins.firstChild.nodeValue;else content.content[ins.getAttribute("xml:lang")]='';});if(member.getElementsByTagName("members").length>0)
content.size=parseInt(member.getElementsByTagName("members")[0].getAttribute("size"));if(member.getElementsByTagName("img").length>0)
content.image=member.getElementsByTagName("img")[0].getAttribute("src");contents[content.target]=content;});return contents;}
function parseItem(data,success,shouldSetGUI){if(typeof(data)=='string')data=$.parseXML(data);var itemType=data.getElementsByTagName("subject")[0].getAttribute("petalType");var id;var item=null;var unloaded=null;var viewID=null;switch(itemType){case"view":id=data.getElementsByTagName("object")[0].getAttribute("id");viewID=data.getElementsByTagName("subject")[0].getAttribute("ref");if(reader.project.items[viewID]==null){item=new HIView(viewID);titles=$(data).find("view > title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)item.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else item.title[titles[i].getAttribute("xml:lang")]='';sources=$(data).find("view > source");for(var i=0;i<sources.length;i++)
if(sources[i].firstChild!=null)item.source[sources[i].getAttribute("xml:lang")]=sources[i].firstChild.nodeValue;else item.source[titles[i].getAttribute("xml:lang")]='';annos=$(data).find("view > annotation");for(var i=0;i<annos.length;i++)
item.annotation[annos[i].getAttribute("xml:lang")]=parseMDField('',annos[i]);item.sites=collectContent($(data).find("sites > site"));item.refs=collectContent($(data).find("references > reference"));if(item.parent!=null)
item.parent.siblings=collectContent($(data).find("siblings > sibling"));else item.siblings=collectContent($(data).find("siblings > sibling"));item.files['images']=new Array();$(data).find('view > img').each(function(index,file){var newFile=new Object();newFile.width=parseInt(file.getAttribute("width"));newFile.height=parseInt(file.getAttribute("height"));newFile.href=file.getAttribute("src");if(file.getAttribute("use")=='thumb')item.files['thumb']=newFile;else item.files['images'].push(newFile);});item.files['images'].sort(function(x,y){return(x.width*x.height)-(y.width*y.height);});item.files['original']=item.files['images'][item.files['images'].length-1];item.sortedLayers=[];$(data).find('view > layer').each(function(index,xmlLayer){var layer=new HILayer(xmlLayer.getAttribute("id"));layer.color=xmlLayer.getAttribute("color");layer.opacity=parseFloat(xmlLayer.getAttribute("opacity"));layer.ref=xmlLayer.getAttribute("ref");layer.order=parseInt(xmlLayer.getAttribute("order"));$(xmlLayer).find("polygon").each(function(pindex,poly){layer.polygons.push(poly.getAttribute("points"));});titles=$(xmlLayer).find("> title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)layer.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else layer.title[titles[i].getAttribute("xml:lang")]='';annos=$(xmlLayer).find("> annotation");for(var i=0;i<annos.length;i++)
layer.annotation[annos[i].getAttribute("xml:lang")]=parseMDField('',annos[i]);layer.parent=item;item.layers[layer.id]=layer;item.sortedLayers.push(layer);reader.project.items[layer.id]=layer;});item.sortedLayers.sort(function(x,y){return y.order-x.order;});reader.project.items[viewID]=item;}
case"inscription":id=data.getElementsByTagName("object")[0].getAttribute("id");viewID=data.getElementsByTagName("subject")[0].getAttribute("ref");if(reader.project.items[viewID]==null){item=new HIInscription(viewID);contents=$(data).find("inscription > content");for(var i=0;i<contents.length;i++)
item.content[contents[i].getAttribute("xml:lang")]=parseMDField('',contents[i]);item.sites=collectContent($(data).find("sites > site"));item.refs=collectContent($(data).find("references > reference"));if(item.parent!=null)
item.parent.siblings=collectContent($(data).find("siblings > sibling"));else item.siblings=collectContent($(data).find("siblings > sibling"));reader.project.items[viewID]=item;}
case"object":id=data.getElementsByTagName("object")[0].getAttribute("id");if(reader.project.items[id]==null){item=new HIObject(id);if(viewID!=null&&reader.project.items[viewID]!=null)
item.siblings=reader.project.items[viewID].siblings;var metadata=$(data).find("object > metadata");for(var i=0;i<metadata.length;i++){var md=metadata[i];var lang=md.getAttribute("xml:lang");item.md[lang]=new Object();var records=md.getElementsByTagName("record");for(var recordID=0;recordID<records.length;recordID++){var rec=records[recordID];var template=rec.getAttribute("template");var values=rec.getElementsByTagName("value");for(var valueID=0;valueID<values.length;valueID++)
item.md[lang][template+"_"+values[valueID].getAttribute("key")]=parseMDField(template+"_"+values[valueID].getAttribute("key"),values[valueID]);}}
item.defaultViewID=data.getElementsByTagName("standardView")[0].getAttribute("ref");reader.project.items[id]=item;}
if(reader.project.items[reader.project.items[id].defaultViewID]==null)unloaded=reader.project.items[id].defaultViewID;else{reader.project.items[reader.project.items[id].defaultViewID].parent=reader.project.items[id];reader.project.items[id].siblings=reader.project.items[reader.project.items[id].defaultViewID].siblings;reader.project.items[id].views[reader.project.items[id].defaultViewID]=reader.project.items[reader.project.items[id].defaultViewID];}
if(viewID!=null&&reader.project.items[viewID].parent==null){reader.project.items[viewID].parent=reader.project.items[id];reader.project.items[id].views[viewID]=reader.project.items[viewID];}
break;case"layer":id=data.getElementsByTagName("object")[0].getAttribute("id");layerID=data.getElementsByTagName("subject")[0].getAttribute("ref");unloaded=data.getElementsByTagName("view")[0].getAttribute("id");var xmlLayer=$(data).find('layer')[0];var layer=new HILayer(xmlLayer.getAttribute("id"));layer.color=xmlLayer.getAttribute("color");layer.opacity=parseFloat(xmlLayer.getAttribute("opacity"));layer.ref=xmlLayer.getAttribute("ref");$(xmlLayer).find("polygon").each(function(pindex,poly){layer.polygons.push(poly.getAttribute("points"));});titles=$(xmlLayer).find("> title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)layer.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else layer.title[titles[i].getAttribute("xml:lang")]='';annos=$(xmlLayer).find("> annotation");for(var i=0;i<annos.length;i++)
layer.annotation[annos[i].getAttribute("xml:lang")]=parseMDField('',annos[i]);if(reader.project.items[layer.id]==null)reader.project.items[layer.id]=layer;break;case"text":id=data.getElementsByTagName("text")[0].getAttribute("id");if(reader.project.items[id]==null){item=new HIText(id);titles=$(data).find("text > title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)item.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else item.title[titles[i].getAttribute("xml:lang")]='';content=$(data).find("text > content");for(var i=0;i<content.length;i++)
item.content[content[i].getAttribute("xml:lang")]=parseMDField('',content[i]);item.sites=collectContent($(data).find("sites > site"));item.refs=collectContent($(data).find("references > reference"));reader.project.items[id]=item;}
break;case"group":id=data.getElementsByTagName("group")[0].getAttribute("id");if(reader.project.items[id]==null){item=new HIGroup(id);titles=$(data).find("group > title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)item.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else item.title[titles[i].getAttribute("xml:lang")]='';annos=$(data).find("group > annotation");for(var i=0;i<annos.length;i++)
item.annotation[annos[i].getAttribute("xml:lang")]=parseMDField('',annos[i]);item.members=collectContent($(data).find("group > member"));item.sites=collectContent($(data).find("sites > site"));item.refs=collectContent($(data).find("references > reference"));reader.project.items[id]=item;}
break;case"url":id=data.getElementsByTagName("url")[0].getAttribute("id");if(reader.project.items[id]==null){item=new HIURL(id);tempTitle=$(data).find("url > title")[0];if(tempTitle!=null&&tempTitle.firstChild!=null)
item.title=tempTitle.firstChild.nodeValue;else item.title='';tempAnno=$(data).find("url > annotation")[0];if(tempAnno!=null&&tempAnno.firstChild!=null)
item.annotation=parseMDField('',tempAnno);else item.annotation='';item.sites=collectContent($(data).find("sites > site"));item.url=data.getElementsByTagName("url")[0].getAttribute("ref");reader.project.items[id]=item;}
break;case'lita':id=data.getElementsByTagName("lita")[0].getAttribute("id");if(reader.project.items[id]==null){item=new HILighttable(id);var titles=$(data).find("lita > title");for(var i=0;i<titles.length;i++)
if(titles[i].firstChild!=null)item.title[titles[i].getAttribute("xml:lang")]=titles[i].firstChild.nodeValue;else item.title[titles[i].getAttribute("xml:lang")]='';var frames=$(data).find("lita > frame");for(var i=0;i<frames.length;i++){var frame=new HIFrame(parseInt(frames[i].getAttribute("x")),parseInt(frames[i].getAttribute("y")),parseInt(frames[i].getAttribute("width")),parseInt(frames[i].getAttribute("height")));frame.imagePos.x=parseInt($(frames[i]).find("frameContent")[0].getAttribute("x"));frame.imagePos.y=parseInt($(frames[i]).find("frameContent")[0].getAttribute("y"));frame.imagePos.width=parseInt($(frames[i]).find("frameContent")[0].getAttribute("width"));frame.imagePos.height=parseInt($(frames[i]).find("frameContent")[0].getAttribute("height"));frame.href=$(frames[i]).find("frameContent")[0].getAttribute("ref");item.frames[i]=frame;}
var frameAnnotation=$(data).find("lita > frameAnn");if(frameAnnotation.length>0){frameAnnotation=frameAnnotation[0];var fa=new Object();fa.annotation=new Object();fa.x=parseInt(frameAnnotation.getAttribute("x"));fa.y=parseInt(frameAnnotation.getAttribute("y"));fa.width=parseInt(frameAnnotation.getAttribute("width"));fa.height=parseInt(frameAnnotation.getAttribute("height"));if(frameAnnotation.getAttribute('visible')=='true')fa.visible=true;var annos=$(frameAnnotation).find("annotation");for(var i=0;i<annos.length;i++)
fa.annotation[annos[i].getAttribute("xml:lang")]=parseMDField('',annos[i]);item.frameAnnotation=fa;}
item.sites=collectContent($(data).find("sites > site"));item.refs=collectContent($(data).find("references > reference"));reader.project.items[id]=item;}
break;}
if(unloaded!=null){console.log("unloaded item: ",unloaded);loadItem(unloaded,true,shouldSetGUI);}else if(shouldSetGUI)setGUI();}
function persistBookmarks(){try{if(window.localStorage!=null)
window.localStorage["bookmarks_"+reader.project.id+"_"+location.host+location.pathname]=JSON.stringify(reader.project.bookmarks);}catch(e){console.log("persist error: ",e);}}
function persistLocalTables(){try{if(window.localStorage!=null)
window.localStorage["lighttables_"+reader.project.id+"_"+location.host+location.pathname]=JSON.stringify(reader.project.localLitas);}catch(e){console.log("persist error: ",e);}}
function saveBookmark(id){if(id==null)id=reader.load;var item=reader.project.items[id];var title=null;if(item.type=='object')item=reader.project.items[item.defaultViewID];if(item.title!=null&&item.title[reader.lang]!=null&&item.title[reader.lang].length>0)title=item.title[reader.lang];else title=item.id;reader.project.bookmarks.push(new HIBookmark(item.id,title));$('#bookmarkmenu').append('<li><a onclick="javascript:checkExternalLink(this);" class="HIExternalLink" href="#'+item.id+'/">'+title+'</a></li>');setMenuItem("deleteBookmarkLink","javascript:deleteBookmark();",true);setMenuItem("deleteAllBookmarksLink","javascript:deleteAllBookmarks();",true);persistBookmarks();}
function deleteBookmark(){if(reader.project.bookmarks.length==0)return;if(!$("#bookmarkmenu").children().last().hasClass("separator")){$("#bookmarkmenu").children().last().remove();reader.project.bookmarks.pop();if($("#bookmarkmenu").children().last().hasClass("separator")){setMenuItem("deleteBookmarkLink","javascript:deleteBookmark();",false);setMenuItem("deleteAllBookmarksLink","javascript:deleteAllBookmarks();",false);}}
persistBookmarks();}
function deleteAllBookmarks(){while($('#beginBookmarks').next().length)
$('#beginBookmarks').next().remove();reader.project.bookmarks.length=0;persistBookmarks();setMenuItem("deleteBookmarkLink","javascript:deleteBookmark();",false);setMenuItem("deleteAllBookmarksLink","javascript:deleteAllBookmarks();",false);}
function getTitle(item){if(item==null)return null;var title=item.id;if(item.type=='view'||item.type=='layer'||item.type=='group'||item.type=='lita'||item.type=='text')title=item.title[reader.lang];if(item.type=='url')title=item.title;if(item.type=='object')title=item.md[reader.lang][[reader.project.sortedFields[1]]];if(item.type=='inscription'){var element=document.createElement("div");$(element).html(item.content[reader.lang]);title=$(element).text();}
if(title==null||title.length==0)title=item.id;return title;}
function setSearch(term){$('#searchInput').val(term);performSearch('word');}
function highlightWord(text,word){var newText=new String(text);var regex=RegExp("\\b("+word+")","gi");var indices=new Array();while((result=regex.exec(text))){indices.unshift(result.index);}
for(var i=0;i<indices.length;i++)
newText=newText.substring(0,indices[i])+'<span class="highlight">'+text.substring(indices[i],indices[i]+word.length)+'</span>'+newText.substring(indices[i]+word.length,newText.length);return newText;}
function performSearch(mode){var term=$('#searchInput').val();var advancedSearch=($('#searchOptions:visible').length>0)?true:false;if(term!=null&&term.length>1){$('#basicSearchButton').hide();$('#extendedSearchButton').show();$('#searchResults').show();$('#searchOptions').hide();reader.search.term=term;reader.search.active=true;var searchTerm=term.toLowerCase();if(reader.project.search[reader.lang]==null)console.log("search delayed");else{var results=new Array();var resultTerms=new Array();$(Object.keys(reader.project.search[reader.lang].entries)).each(function(index,word){if(mode==null?(word.substring(0,searchTerm.length)==searchTerm):(word==searchTerm)){if(!advancedSearch){resultTerms.push(word);$(Object.keys(reader.project.search[reader.lang].entries[word])).each(function(index,ref){if($.inArray(ref,results)<0)results.push(ref);});}else{$(Object.keys(reader.project.search[reader.lang].entries[word])).each(function(index,ref){var inKey=false;for(var i=0;i<reader.project.search[reader.lang].entries[word][ref].length;i++){var key=reader.project.search[reader.lang].entries[word][ref][i];if($('#'+reader.project.search[reader.lang].subByNumber[key]+'_check').is(':checked'))inKey=true;}
if(inKey&&$.inArray(ref,results)<0)results.push(ref);if($.inArray(word,resultTerms)<0)resultTerms.push(word);});}}});$('#searchResultsContent').empty();var resultText=(reader.strings[reader.lang]['SEARCH_RESULT_BASIC']==null)?'Fundstellen bei der Standardsuche nach':reader.strings[reader.lang]['SEARCH_RESULT_BASIC'];var advResultText=(reader.strings[reader.lang]['SEARCH_RESULT_ADVANCED']==null)?'Fundstellen bei der erweiterten Suche nach':reader.strings[reader.lang]['SEARCH_RESULT_ADVANCED'];var andText=(reader.strings[reader.lang]['SEARCH_AND']==null)?'und':reader.strings[reader.lang]['SEARCH_AND'];var noResultsText=(reader.strings[reader.lang]['SEARCH_NO_RESULTS']==null)?'Kein Suchergebnis für':reader.strings[reader.lang]['SEARCH_NO_RESULTS'];if(results.length>0){reader.search.resultTerms=resultTerms;reader.search.resultTerms=resultTerms.sort(function(a,b){return b.length-a.length;});if(!advancedSearch)$('#searchResultsContent').append(results.length+' '+resultText+' ');else $('#searchResultsContent').append(results.length+' '+advResultText+' ');for(var i=0;i<resultTerms.length;i++){if(resultTerms.length>1)if(i==(resultTerms.length-1))$('#searchResultsContent').append(' '+andText+' ');else if(i>0)$('#searchResultsContent').append(', ');$('#searchResultsContent').append('"<a href="javascript:setSearch(\''+resultTerms[i]+'\');">'+resultTerms[i]+'</a>"');}
$('#searchResultsContent').append(':<br><br>');$(results).each(function(index,result){if(reader.project.items[result]!=null){var item=reader.project.items[result];var title=getTitle(item);if(title!=null&&title.length>31)title=title.substring(0,31)+"...";$('#searchResultsContent').append('<a id="'+result+'_result" onclick="javascript:reader.fromSearch = true;checkExternalLink(this);" class="HIExternalLink" href="#'+result+'/">'+title+'</a><span> '+reader.strings[reader.lang][searchTypeKeys[item.type]]+'</span><br>');}else{$('#searchResultsContent').append('<a id="'+result+'_result" onclick="javascript:reader.fromSearch = true;checkExternalLink(this);" class="HIExternalLink" href="#'+result+'/">'+result+'</a><span>&nbsp;</span><br>');$.get(reader.path+result+'.xml',function(data,success){parseItem(data,success,false);var item=reader.project.items[result];var title=getTitle(item);if(title!=null&&title.length>31)title=title.substring(0,31)+"...";$('#'+result+'_result').text(title);$('#'+result+'_result').next().empty().text(' '+reader.strings[reader.lang][searchTypeKeys[item.type]]);setLoadingIndicator(false);});}});}else{$('#searchResultsContent').append(noResultsText+' "'+term+'".');reader.search.resultTerms=new Array();}
reader.search.active=false;}}}
function checkExternalLink(link){var href=typeof(link)=='string'?link:link.getAttribute('href');var xmlData=null;if(href.substring(0,2)=='#U'){href=href.substring(1,href.length);if(href.substring(href.length-1,href.length)=='/')href=href.substring(0,href.length-1);if(reader.project.items[href]==null){$.ajax({url:reader.path+href+'.xml',async:false,data:null,dataType:'xml',success:function(data){xmlData=data;}});if(xmlData!=null)parseItem(xmlData,'success');}
if(reader.project.items[href]!=null){window.open(reader.project.items[href].url,'_newtab');event.preventDefault();return true;}}
return false;}
function attachExternalLinkHandler(element,item){var filetype=item.url.substring(item.url.lastIndexOf('.')+1,item.url.length).toLowerCase();switch(filetype){case'mp3':$(element).mb_miniPlayer({width:0,inLine:true,addShadow:false,id3:false,skin:"black",playAlone:true,volume:100,mp3:item.url});break;case'ogg':$(element).mb_miniPlayer({width:0,inLine:true,addShadow:false,id3:false,skin:"black",playAlone:true,volume:100,ogg:item.url});break;default:break;}}
function scanExternalLinks(){$('.HIExternalLink').each(function(index,item){if($(item).attr("href").substring(0,2)=='#U'){var href=$(item).attr("href").substring(1,$(item).attr("href").length);if(href.substring(href.length-1,href.length)=='/')href=href.substring(0,href.length-1);if(reader.project.items[href]==null){$.ajax({url:reader.path+href+'.xml',async:true,data:null,dataType:'xml',success:function(data){parseItem(data,'success');if(reader.project.items[href]!=null)attachExternalLinkHandler(item,reader.project.items[href]);}});}else attachExternalLinkHandler(item,reader.project.items[href]);}});}
function loadContentThumbnail(imgTag,indicatorTag,ref,type){imgTag.attr('src',ref);imgTag.load(function(e){indicatorTag.remove();});}
function displayContentList(contentsList){setGUIMode(2);reader.contentsList=contentsList;$('#groupList > li').remove();$("#groupView div[id^=tt-]").remove();$(Object.keys(contentsList)).each(function(index,key){var classType='';if(contentsList[key].type=='object'||contentsList[key].type=='view'||contentsList[key].type=='layer')
classType=' class="hasContentsContextMenu"';var html='<li id="cl-'+key+'"'+classType;if(contentsList[key].image!=null)html+='>';else html+=' class="text">';html+='<a onclick="javascript:checkExternalLink(this);" class="HIExternalLink" href="#'+contentsList[key].target+'/">';if(contentsList[key].image!=null){html+='<div class="contentLoadingIndicator"></div>';html+='<img src="#" />';}
else{html+='<span class="'+typeKeys[contentsList[key].type]+'">'+reader.strings[reader.lang][typeKeys[contentsList[key].type]]+'</span>';if(contentsList[key].type=='group'||contentsList[key].type=='lightTable')html+=" ("+contentsList[key].size+")";html+='<br /><br />';if(contentsList[key].type!='inscription'&&contentsList[key].type!='text')html+='"'+contentsList[key].title[reader.lang]+'"';else if(contentsList[key].type=='text'||contentsList[key].type=='inscription')html+=contentsList[key].content[reader.lang];else html+=contentsList[key].title;}
html+="</a></li>\n";$('#groupList').append(html);$('#cl-'+key).data('contentType',contentsList[key].type);if(classType.length==0)$('#cl-'+key).bind('contextmenu',function(ev){ev.preventDefault();});if(contentsList[key].image!=null){$('#cl-'+key+' .contentLoadingIndicator').activity({segments:12,width:2,space:1,length:4,speed:1.2});loadContentThumbnail($('#cl-'+key+' img'),$('#cl-'+key+' .contentLoadingIndicator'),contentsList[key].image,contentsList[key].type);}
var tooltipDiv='<div id="tt-cl-'+key+'" class="tooltip"><div class="tooltipContent">';tooltipDiv+='<span class="'+typeKeys[contentsList[key].type]+'">'+reader.strings[reader.lang][typeKeys[contentsList[key].type]]+'</span><br /><br />';if(contentsList[key].type=='url'&&contentsList[key].title!=null&&contentsList[key].title.length>0)tooltipDiv+=contentsList[key].title+"<br />";else if(contentsList[key].title[reader.lang]!=null&&contentsList[key].title[reader.lang].length>0)tooltipDiv+=contentsList[key].title[reader.lang]+"<br />";else tooltipDiv+='ID '+contentsList[key].target+'<br />';tooltipDiv+='</div><div class="tooltipBackground">&nbsp;</div></div>';$('#groupView').append(tooltipDiv);$('#cl-'+key).tooltip({tip:"#tt-cl-"+key,relative:true,predelay:300,delay:0,position:'center left',onBeforeShow:function(tt,pos){$(tt.target).tooltip().getConf().offset[1]=Math.round(reader.pageX-pos.left)+64;},onBeforeHide:function(tt,pos){tt.currentTarget.getConf().offset[1]=0;},});});}
function addLayerToLightTable(layerID){if(layerID==null)return;var layer=reader.project.items[layerID];var bounds=getLayerBounds(layerID);if(layer==null)return;var view=layer.parent;if(view==null)return;var layerWidth=(bounds.maxX-bounds.minX)*view.files['original'].width;var layerHeight=(bounds.maxY-bounds.minY)*view.files['original'].height;var factor=128.0/Math.max(layerWidth,layerHeight);var displayWidth=Math.ceil(view.files['original'].width*factor);var displayHeight=Math.ceil(view.files['original'].height*factor);var frameWidth=Math.min(128,displayWidth);var frameHeight=Math.min(128,displayHeight);var xPos=Math.min(0,Math.round(frameWidth/2.0-((bounds.minX+bounds.maxX)*displayWidth/2.0)));var yPos=Math.min(0,Math.round(frameHeight/2.0-((bounds.minY+bounds.maxY)*displayHeight/2.0)));var frame=new HIFrame(20+(16*reader.table.frames.length),66+(16*reader.table.frames.length),frameWidth,frameHeight);frame.href=view.id;frame.imagePos.x=xPos;frame.imagePos.y=yPos;frame.imagePos.width=displayWidth;frame.imagePos.height=displayHeight;reader.table.frames.push(frame);}
function addViewToLightTable(viewID){if(viewID==null)viewID=reader.viewID;if(viewID==null)return;var view=reader.project.items[viewID];if(view==null)return;var frame=new HIFrame(20+(16*reader.table.frames.length),66+(16*reader.table.frames.length),view.files['thumb'].width,view.files['thumb'].height);frame.href=view.id;frame.imagePos.x=0;frame.imagePos.y=0;frame.imagePos.width=view.files['thumb'].width;frame.imagePos.height=view.files['thumb'].height;reader.table.frames.push(frame);}
function duplicateFrame(){var isAnnotation=false;var selectedFrame=$("#lighttableContent > div.ltSelected");if(selectedFrame.length==0)selectedFrame=null;else selectedFrame=selectedFrame[0];if(selectedFrame!=null)isAnnotation=$(selectedFrame).hasClass('ltAnnotation');if(selectedFrame!=null&&!isAnnotation){var frame=new HIFrame($('#lighttableContent').scrollLeft()+$(selectedFrame).position().left+16,$('#lighttableContent').scrollTop()+$(selectedFrame).position().top+32+reader.zoom.yOffset,$(selectedFrame).width(),$(selectedFrame).height());frame.href=$(selectedFrame).data('viewID');var img=$('#'+selectedFrame.id+' img');frame.imagePos.x=$(img).position().left;frame.imagePos.y=$(img).position().top;frame.imagePos.width=$(img).width();frame.imagePos.height=$(img).height();reader.table.frames.push(frame);var guiFrame=window.addFrame(frame);var sortedFrames=$.makeArray($('.ltFrame')).sort(function(a,b){return(parseInt($(a).css("zIndex"),10)||0)-(parseInt($(b).css("zIndex"),10)||0);});min=parseInt($(sortedFrames[0]).css("zIndex"),10)||0;$(guiFrame).css("zIndex",(min+sortedFrames.length));window.syncTableToModel();}}
function removeFrame(){var isAnnotation=false;var selectedFrame=$("#lighttableContent > div.ltSelected");if(selectedFrame.length==0)selectedFrame=null;else selectedFrame=selectedFrame[0];if(selectedFrame!=null)isAnnotation=$(selectedFrame).hasClass('ltAnnotation');$(selectedFrame).remove();window.setLightTableMenuGUI();window.syncTableToModel();}
function fitToFrame(){var isAnnotation=false;var selectedFrame=$("#lighttableContent > div.ltSelected");if(selectedFrame.length==0)selectedFrame=null;else selectedFrame=selectedFrame[0];if(selectedFrame!=null)isAnnotation=$(selectedFrame).hasClass('ltAnnotation');var img=$('#'+selectedFrame.id+' img');var view=reader.project.items[$(selectedFrame).data('viewID')];var scale=Math.max($(selectedFrame).width()/view.files['original'].width,($(selectedFrame).height()-16)/view.files['original'].height);$(img).css('top','0px');$(img).css('left','0px');$(img).width(view.files['original'].width*scale);$(img).height(view.files['original'].height*scale);$(selectedFrame).width(view.files['original'].width*scale);$(selectedFrame).height((view.files['original'].height*scale)+16);window.syncTableToModel();}
function fitToThumb(){var isAnnotation=false;var selectedFrame=$("#lighttableContent > div.ltSelected");if(selectedFrame.length==0)selectedFrame=null;else selectedFrame=selectedFrame[0];if(selectedFrame!=null)isAnnotation=$(selectedFrame).hasClass('ltAnnotation');var img=$('#'+selectedFrame.id+' img');var view=reader.project.items[$(selectedFrame).data('viewID')];$(img).css('top','0px');$(img).css('left','0px');$(img).width(view.files['thumb'].width);$(img).height(view.files['thumb'].height);$(selectedFrame).width(view.files['thumb'].width);$(selectedFrame).height(view.files['thumb'].height+16);window.syncTableToModel();}
function addAnnotation(){reader.table.frameAnnotation.visible=true;for(var i=0;i<reader.project.langs.length;i++)
if(reader.table.frameAnnotation.annotation[reader.project.langs[i]]==null||reader.table.frameAnnotation.annotation[reader.project.langs[i]].length==0)
reader.table.frameAnnotation.annotation[reader.project.langs[i]]='...';window.addFrame();window.setLightTableMenuGUI();}
function removeAnnotation(){var annotation=$('.ltAnnotation');if(annotation==null||annotation.length==0)return;$('.ltAnnotation').remove();reader.table.frameAnnotation.visible=false;window.setLightTableMenuGUI();}
function insertAnnotationLink(){var linkField=$('#insertLinkField');var selection=window.getSelection();linkField.val('');var link=document.createElement('a');var href=document.createAttribute('href');var clattr=document.createAttribute('class');clattr.nodeValue='HIExternalLink';link.setAttributeNode(href);link.setAttributeNode(clattr);var sel=window.getSelection();var range=null;if(sel.rangeCount)range=sel.getRangeAt(0);var diagButtons={};diagButtons[reader.strings[reader.lang]['STR_CANCEL']]=function(){$(this).dialog("close");};diagButtons[reader.strings[reader.lang]['STR_OK']]=function(){if($.trim(linkField.val()).length>0){href.nodeValue="#"+$.trim(linkField.val());if(range!=null){var text=$(range.startContainer).text().substring(range.startOffset,range.endOffset);link.appendChild(document.createTextNode(text));range.deleteContents();$(link).click(function(ev){followLiTaLink(this);});range.insertNode(link);}}
$(this).dialog("close");};$("#insertLinkDialog").dialog({draggable:false,resizable:false,title:reader.strings[reader.lang]['MENULITA_INSERT_LINK'],width:400,height:170,modal:true,buttons:diagButtons});}
function returnFromLightTable(){if(reader.project.items[reader.load].type=='lita'){if(reader.last!=null)location.hash=reader.last+'/';else location.hash=reader.start+'/';}else setGUI();}
function nameTable(){$('#tableNameInput').val(reader.table.title[reader.lang]);$("#nameTableDialog").dialog({draggable:false,resizable:false,title:reader.strings[reader.lang]['MENULITA_NAME'],width:300,height:175,modal:true,buttons:{"Abbrechen":function(){$(this).dialog("close");},"OK":function(){reader.table.title[reader.lang]=$('#tableNameInput').val();window.setLightTableMenuGUI();$(this).dialog("close");}}});}
function showTableXML(){window.syncTableToModel();var xmlText="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n";xmlText+="<petal id=\""+reader.project.id+"\">\n";xmlText+="  <subject ref=\"none\" petalType=\"lita\" />\n";xmlText+="  <lita id=\"none\">\n";for(var i=0;i<reader.project.langs.length;i++){var title='';if(reader.table.title[reader.project.langs[i]]!=null)title=reader.table.title[reader.project.langs[i]];xmlText+="    <title xml:lang=\""+reader.project.langs[i]+"\">"+title+"</title>\n";}
$(reader.table.frames).each(function(index,frame){xmlText+="    <frame order=\""+(index+1)+"\" x=\""+frame.x+"\" y=\""+frame.y+"\" width=\""+frame.width+"\" height=\""+frame.height+"\">\n";xmlText+="      <frameContent ref=\""+frame.href+"\" x=\""+frame.imagePos.x+"\" y=\""+frame.imagePos.y+"\" width=\""+frame.imagePos.width+"\" height=\""+frame.imagePos.height+"\" />\n";xmlText+="    </frame>\n";});xmlText+="<frameAnn visible=\""+
reader.table.frameAnnotation.visible+"\" x=\""+reader.table.frameAnnotation.x+"\" y=\""+reader.table.frameAnnotation.y+"\" width=\""+reader.table.frameAnnotation.width+"\" height=\""+reader.table.frameAnnotation.height+"\" >\n";for(var i=0;i<reader.project.langs.length;i++){xmlText+="      <annotation xml:lang=\""+reader.project.langs[i]+"\">\n";var anString=reader.table.frameAnnotation.annotation[reader.project.langs[i]];anString=anString.replace(/ onclick=\"javascript:checkExternalLink\(this\);\"/g,'');anString=anString.replace(/ class=\"HIExternalLink\"/g,'');anString=anString.replace(/<a href=/g,'<link ref=');anString=anString.replace(/<a  href=/g,'<link ref=');anString=anString.replace(/<\/a>/g,'</link>');anString=anString.replace(/<link ref=\"#/g,'<link ref="');var xmlString='';$(anString.split('<br>')).each(function(index,line){xmlString+='        <line>'+line+"</line>\n";});xmlText+=xmlString;xmlText+="      </annotation>\n";}
xmlText+="    </frameAnn>\n";xmlText+="  </lita>\n";xmlText+="</petal>\n";$('#tableXML').val(xmlText);var diagButtons={};diagButtons[reader.strings[reader.lang]['STR_OK']]=function(){$(this).dialog("close");};$("#showTableXMLDialog").dialog({draggable:false,resizable:false,title:reader.strings[reader.lang]['MENULITA_XML_CLIPBOARD'],width:500,height:400,modal:true,buttons:diagButtons});$('#tableXML').select();}
function newLocalTable(displayTable){reader.table=new HILighttable();for(var i=0;i<reader.project.langs.length;i++){var title='-';if(reader.strings[reader.project.langs[i]]!=null&&reader.strings[reader.project.langs[i]]['FILE_UNTITLED']!=null)
title=reader.strings[reader.project.langs[i]]['FILE_UNTITLED'];reader.table.title[reader.project.langs[i]]=title;reader.table.frameAnnotation.annotation[reader.project.langs[i]]="...";}
if(displayTable)displayLightTable();}
function saveLocalTable(){window.syncTableToModel();reader.table.id=null;reader.table.sites=null;reader.table.refs=null;reader.project.localLitas.push(JSON.parse(JSON.stringify(reader.table)));persistLocalTables();$('#endLocalLightTables').before('<li><a href="javascript:loadLocalTable('+(reader.project.localLitas.length-1)+');">'+reader.project.localLitas[reader.project.localLitas.length-1].title[reader.lang]+'</a></li>');setMenuItem("deleteLocalTableLink","javascript:deleteLocalTable();",true);}
function deleteLocalTable(){if(reader.project.localLitas.length==0)return;reader.project.localLitas.pop();persistLocalTables();$('#endLocalLightTables').prev().remove();if(reader.project.localLitas.length==0)setMenuItem("deleteLocalTableLink","javascript:deleteLocalTable();",false);}
function loadLocalTable(index){if(index<0||index>reader.project.localLitas.length)return;reader.table=JSON.parse(JSON.stringify(reader.project.localLitas[index]));displayLightTable();}
function followLiTaLink(link){location.hash=link.getAttribute('href')+'/';}
function loadFrame(item){$.get(reader.path+item.href+'.xml',function(data,success){parseItem(data,success,false);setLoadingIndicator(false);addFrame(item);});}
function loadFrameHiRes(id,view){var hiRes=findHigherRes(view,$('#'+id+"_content img").attr('src'),$('#'+id+"_content img").width(),$('#'+id+"_content img").height());if(hiRes!=null){var newImg=new Image();newImg.src=hiRes.href;$('#'+id+'_loading').show();newImg.onload=function(){$('#'+id+"_content img").attr('src',hiRes.href);$('#'+id+'_loading').hide();};}}
function displayLightTable(){var frameCount=0;$('#lighttableContent > div').remove();if(reader.table==null)return;setGUIMode(3);setMenuState();function syncTableToModel(){var frames=new Array();var sortedFrames=$.makeArray($('.ltFrame')).sort(function(a,b){return(parseInt($(a).css("zIndex"),10)||0)-(parseInt($(b).css("zIndex"),10)||0);});$(sortedFrames).each(function(index,item){if($(item).hasClass('ltAnnotation')){reader.table.frameAnnotation.x=$(item).position().left+$('#lighttableContent').scrollLeft();reader.table.frameAnnotation.y=$(item).position().top+$('#lighttableContent').scrollTop()+64;reader.table.frameAnnotation.width=$(item).width();reader.table.frameAnnotation.height=$(item).height()-16;$(item).find(' .ltText').get(0).normalize();var serialized=$('#'+item.id+' .ltText').html().toString().trim().replace(/\s+/g,' ');var anString='';$(serialized.split('<br>')).each(function(index,item){anString+=item.trim()+'<br>';});if(anString.length>=4&&anString.substring(anString.length-4,anString.length)=='<br>')
anString=anString.substring(0,anString.length-4);anString=anString.replace(/<div>/g,'<br>');anString=anString.replace(/<\/div>/g,'');reader.table.frameAnnotation.annotation[reader.lang]=anString;}else{var newFrame=new HIFrame($(item).position().left+$('#lighttableContent').scrollLeft(),$(item).position().top+$('#lighttableContent').scrollTop()+64,$(item).width(),$(item).height()-16);newFrame.href=$(item).data('viewID');newFrame.imagePos.x=$('#'+item.id+" img").position().left;newFrame.imagePos.y=$('#'+item.id+" img").position().top;newFrame.imagePos.width=$('#'+item.id+" img").width();newFrame.imagePos.height=$('#'+item.id+" img").height();frames.push(newFrame);}
reader.table.frames=frames;});}
window.syncTableToModel=syncTableToModel;function setFramePos(id,x,y,width,height){$('#'+id).css('left',x+'px');$('#'+id).css('top',y+'px');$('#'+id).css('width',width+'px');$('#'+id).css('height',height+'px');}
window.setFramePos=setFramePos;function setLightTableMenuGUI(){var viewLink=null;var isAnnotation=false;var selectedFrame=$("#lighttableContent > div.ltSelected");if(selectedFrame.length==0)selectedFrame=null;else selectedFrame=selectedFrame[0];if(selectedFrame!=null)isAnnotation=$(selectedFrame).hasClass('ltAnnotation');setMenuItem('duplicateLink','javascript:duplicateFrame();',false);setMenuItem('removeLink','javascript:removeFrame();',false);setMenuItem('fitFrameLink','javascript:fitToFrame();',false);setMenuItem('fitToThumbLink','javascript:fitToThumb();',false);setMenuItem('addAnnotationLink_ON','javascript:addAnnotation();',true);setMenuItem('addAnnotationLink_OFF','javascript:removeAnnotation();',true);toggleMenuItem('addAnnotationLink',(!reader.table.frameAnnotation.visible));setMenuItem('insertLinkLink','javascript:insertAnnotationLink();',false);setMenuItem('nameTableLink','javascript:nameTable();',true);setMenuItem('saveTableLink','javascript:saveLocalTable();',true);setMenuItem('newTableLink','javascript:newLocalTable(true);',true);setMenuItem('copyXMLLink','javascript:showTableXML();',true);if(selectedFrame!=null){if(isAnnotation){setMenuItem('insertLinkLink','javascript:insertAnnotationLink();',true);}else{viewLink=$(selectedFrame).data('viewID');setMenuItem('duplicateLink','javascript:duplicateFrame();',true);setMenuItem('removeLink','javascript:removeFrame();',true);setMenuItem('fitFrameLink','javascript:fitToFrame();',true);setMenuItem('fitToThumbLink','javascript:fitToThumb();',true);}}
setMenuItem('showViewLink','#'+viewLink+'/',(viewLink!=null));var title=reader.table.title[reader.lang];if(title==null||title.length==0)title=reader.strings[reader.lang]['FILE_UNTITLED'];if(title==null)title='-';reader.table.title[reader.lang]=title;$('#infotext').text(reader.strings[reader.lang]['INFOLINE_LITA']+' '+title);}
window.setLightTableMenuGUI=setLightTableMenuGUI;function addFrame(item){frameCount++;var id="table_"+frameCount;if(item==null)id='table_anno';$('#lighttableContent').append('<div id="'+id+'" class="ltFrame ltstack" style="position: absolute;"></div>');$('#'+id).append('<div id="'+id+'_title" class="ltFrameTitle">&nbsp;</div><div id="'+id+'_content" class="ltFrameContent"></div>');$('#'+id).append('<div id="'+id+'_contain" class="ltResizeContainer"><canvas id="'+id+'_canvas" class="ltResizeCanvas"></canvas></div>');var context=document.getElementById(id+'_canvas').getContext('2d');if(item==null){setFramePos(id,reader.table.frameAnnotation.x,reader.table.frameAnnotation.y-16-reader.zoom.yOffset,reader.table.frameAnnotation.width,reader.table.frameAnnotation.height+16);$('#'+id).addClass('ltAnnotation');$('#'+id).bind('contextmenu',function(ev){ev.preventDefault();});$('#'+id+"_content").html('<div class="ltText" contenteditable="true">'+reader.table.frameAnnotation.annotation[reader.lang]+'</div>');$('#'+id+'_content .ltText').width($('#'+id).width()-14).height($('#'+id).height()-32);$('#'+id+' .ltText').bind('blur keyup paste',function(){window.syncTableToModel();});context.fillStyle=reader.prefs['LITA_COLOR_TOOL2'];context.beginPath();context.moveTo(0,150);context.lineTo(300,150);context.lineTo(300,0);context.fill();}else{$('#'+id).addClass('hasLitaContextMenu');$('#'+id).data('viewID',item.href);$('#'+id).append('<div id="'+id+'_loading" class="ltLoadingIndicator"></div>');$('#'+id+'_loading').activity({segments:12,width:9,space:6,length:20,speed:2.2});setFramePos(id,item.x,item.y-16-reader.zoom.yOffset,item.width,item.height+16);$('#'+id+"_content").append('<img src="'+reader.project.items[item.href].files['images'][0].href+'" />');setFramePos(id+"_content img",0,0,item.imagePos.width,item.imagePos.height);$('#'+id+"_content").scrollLeft(Math.abs(item.imagePos.x)).scrollTop(Math.abs(item.imagePos.y));var view=reader.project.items[item.href];var minScale=Math.max(32.0/view.files['original'].width,32.0/view.files['original'].height);$('#'+id).css('max-width',(view.files['original'].width*3)+'px');$('#'+id).css('max-height',(view.files['original'].height*3)+'px');var startX=0;var startY=0;var startWidth=0;var startHeight=0;context.fillStyle=reader.prefs['LITA_COLOR_TOOL2'];context.fillRect(0,0,300,150);context.fillStyle=reader.prefs['LITA_COLOR_TOOL1'];context.beginPath();context.moveTo(0,0);context.lineTo(300,0);context.lineTo(0,150);context.fill();$('#'+id+'_canvas').draggable({containment:'parent',start:function(e,ui){startX=e.screenX;startY=e.screenY;startWidth=$('#'+id+"_content img").width();startHeight=$('#'+id+"_content img").height();},drag:function(e,ui){var newScale=Math.abs(e.screenX-startX)>Math.abs(e.screenY-startY)?(e.screenX-startX):(e.screenY-startY);newScale=(startWidth+(newScale*2))/view.files['original'].width;newScale=Math.min(3.0,newScale);newScale=Math.max(minScale,newScale);scrollX=$('#'+id+"_content").scrollLeft()+((view.files['original'].width*newScale)-$('#'+id+"_content img").width())/2;scrollY=$('#'+id+"_content").scrollTop()+((view.files['original'].height*newScale)-$('#'+id+"_content img").height())/2;$('#'+id+"_content img").width(view.files['original'].width*newScale);$('#'+id+"_content img").height(view.files['original'].height*newScale);$('#'+id+"_content").scrollLeft(scrollX).scrollTop(scrollY);if($('#'+id).width()>$('#'+id+"_content img").width())$('#'+id).width($('#'+id+"_content img").width());if($('#'+id).height()>$('#'+id+"_content img").height())$('#'+id).height($('#'+id+"_content img").height());ui.position.left=0;ui.position.top=0;},stop:function(e,ui){loadFrameHiRes(id,view);window.syncTableToModel();}});$('#'+id+"_content").dragscrollable({acceptPropagatedEvent:true});$('#'+id+"_content").bind('mouseup',function(e){window.syncTableToModel();});var title='';if(reader.project.items[item.href].parent.md[reader.lang]!=null&&reader.project.items[item.href].parent.md[reader.lang][reader.project.sortedFields[1]]!=null)
title=reader.project.items[item.href].parent.md[reader.lang][reader.project.sortedFields[1]];$('#'+id+"_title").text(title);}
$('#'+id).draggable({handle:'#'+id+"_title",drag:function(event,ui){ui.position.top=Math.max(2,ui.position.top);ui.position.left=Math.max(0,ui.position.left);},stop:function(event,ui){window.syncTableToModel();}});$('#'+id+'_content .ltText a').click(function(ev){followLiTaLink(this);});$('#'+id).resizable({autoHide:true,resize:function(event,ui){if(view!=null){if($('#'+id).width()>$('#'+id+"_content img").width()||$('#'+id).height()>$('#'+id+"_content img").height()){var scale=Math.max($('#'+id).width()/view.files['original'].width,$('#'+id).height()/view.files['original'].height);$('#'+id+"_content img").width(view.files['original'].width*scale);$('#'+id+"_content img").height(view.files['original'].height*scale);}}else{$('#'+id+'_content .ltText').width($('#'+id).width()-14);$('#'+id+'_content .ltText').height($('#'+id).height()-32);}},stop:function(event,ui){loadFrameHiRes(id,view);window.syncTableToModel();}});$('#'+id+'_content img, #'+id+'_content .ltText, #'+id).mousedown(function(e){$("#lighttableContent > div.ltSelected").removeClass("ltSelected");$('#'+id).addClass('ltSelected');if($('#'+id).hasClass('ltAnnotation'))$('#table_anno .ltText').focus();else $('#emptyInput').focus();var sortedFrames=$.makeArray($('.ltFrame')).sort(function(a,b){return(parseInt($(a).css("zIndex"),10)||0)-(parseInt($(b).css("zIndex"),10)||0);});min=parseInt($(sortedFrames[0]).css("zIndex"),10)||0;$(sortedFrames).each(function(i){$(this).css("zIndex",min+i);});$('#'+id).css("zIndex",(min+sortedFrames.length));setLightTableMenuGUI();});if(view!=null)loadFrameHiRes(id,view);return $('#'+id);}
window.addFrame=addFrame;$(reader.table.frames).each(function(index,item){if(reader.project.items[item.href]==null){loadFrame(item);}else addFrame(item);});if(reader.table.frameAnnotation.visible)addFrame();$('#content').mousedown(function(e){var isOverFrame=false;$('.ltFrame').each(function(index,item){if(e.pageX>=$(item).position().left&&(e.pageY-reader.zoom.yOffset)>=$(item).position().top&&e.pageX<=($(item).position().left+$(item).width())&&(e.pageY-reader.zoom.yOffset)<=($(item).position().top+$(item).height()))
isOverFrame=true;});if(!isOverFrame){$("#lighttableContent > div.ltSelected").removeClass("ltSelected");$('#emptyInput').focus();setLightTableMenuGUI();}});setLightTableMenuGUI();}
function getLayerBounds(layerID){var bounds={minX:1.0,maxX:0.0,minY:1.0,maxY:0.0};if(layerID==null||reader.project.items[layerID]==null)return bounds;var layer=reader.project.items[layerID];for(index in layer.polygons){var polygon=layer.polygons[index];for(var a=0;a<polygon.split(' ').length;a++){var coord=polygon.split(' ')[a];var x=parseFloat(coord.split(',')[0]);var y=parseFloat(coord.split(',')[1]);if(bounds.minX>x)bounds.minX=x;if(bounds.maxX<x)bounds.maxX=x;if(bounds.minY>y)bounds.minY=y;if(bounds.maxY<y)bounds.maxY=y;}}
return bounds;}
function calcImageScales(){var view=reader.project.items[reader.load];if(view==null)return;if(view.type=='object')view=view.views[view.defaultViewID];else
if(view.type=='layer')view=view.parent;else
if(view.type!='view'&&view.type!='layer'&&view.type!='inscription')return;if(reader.mode!='regular')return;if(view.type=='inscription'){view=getObject(view).views[getObject(view).defaultViewID];}
reader.zoom.min=100.0/Math.max(view.files['original'].width,view.files['original'].height);if(view.files['original'].width>view.files['original'].height)
reader.zoom.window=($('#canvas').height()-reader.zoom.yOffset)*1.0/view.files['original'].height;else
reader.zoom.window=1.0*($('#canvas').width()-reader.zoom.xOffset)/view.files['original'].width;reader.zoom.image=Math.min(1.0*($('#canvas').width()-$('#sidebar').width())/view.files['original'].width,($('#canvas').height()-reader.zoom.yOffset)*1.0/view.files['original'].height);reader.zoom.width=view.files['original'].width;reader.zoom.height=view.files['original'].height;}
function zoomIn(){if(!$('#zoomInLink').parent().is('.disabled'))
scaleImageTo(reader.zoom.cur*2.0);}
function zoomOut(){if(!$('#zoomOutLink').parent().is('.disabled'))
scaleImageTo(reader.zoom.cur/2.0);}
function scaleImageTo(scale){scale=Math.max(reader.zoom.min,scale);scale=Math.min(reader.zoom.max,scale);if(scale==reader.zoom.min)setZoomGUI(true,false);else if(scale==reader.zoom.max)setZoomGUI(false,true);else setZoomGUI(true,true);var xPos=0;var yPos=0;if(reader.prefs['VIEW_CENTER']!=null&&reader.prefs['VIEW_CENTER']=='true'){xPos=Math.max(0,Math.round((($(window).width()-reader.zoom.xOffset)-(reader.zoom.width*scale))/2));yPos=Math.max(0,Math.round((($(window).height()-reader.zoom.yOffset)-(reader.zoom.height*scale))/2));}
reader.canvas.imageGroup.setAttribute('transform','translate('+xPos+','+(reader.zoom.yOffset+yPos)+') scale('+scale+')');reader.canvas.svg.change(reader.canvas.svg.root(),{x:0,y:0,width:Math.round(reader.zoom.width*scale)+xPos,height:Math.round(reader.zoom.height*scale)+reader.zoom.yOffset+yPos});$(reader.canvas.layerGroup).find("g").each(function(index,group){if($(group).attr("stroke-width")>0)
$(group).attr("stroke-width",1*(1/reader.zoom.cur));});reader.zoom.cur=scale;loadHiResIfNeeded();}
function setZoomGUI(zoomInEnabled,zoomOutEnabled){$('#zoomInLink').attr("href",location.hash);$('#zoomOutLink').attr("href",location.hash);if(zoomInEnabled)$('#zoomInLink').parent().removeClass("disabled");else $('#zoomInLink').parent().addClass("disabled");if(zoomOutEnabled)$('#zoomOutLink').parent().removeClass("disabled");else $('#zoomOutLink').parent().addClass("disabled");}
function showID(){var item=reader.project.items[reader.load];if(item==null)return;var viewID=null;var output='';switch(item.type){case'object':output=reader.strings[reader.lang]['ID_OBJECT']+' '+item.id;viewID=item.defaultViewID;break;case'view':output=reader.strings[reader.lang]['ID_OBJECT']+' '+item.parent.id;viewID=item.id;break;case'layer':output=reader.strings[reader.lang]['ID_LAYER']+' '+item.id;viewID=item.parent.id;break;case'inscription':output=reader.strings[reader.lang]['ID_INSCRIPTION']+' '+item.id;break;case'text':output=reader.strings[reader.lang]['ID_TEXT']+' '+item.id;break;case'lita':output=reader.strings[reader.lang]['ID_LITA']+' '+item.id;break;}
if(viewID!=null)output+='&nbsp;&nbsp;|&nbsp;&nbsp;'+reader.strings[reader.lang]['ID_VIEW']+' '+viewID;$('#infotext').html(output);}
function highlightAllLayers(){$(reader.canvas.layerGroup).find("g").each(function(index,group){var layer=reader.project.items[$(group).attr('id').substring(0,$(group).attr('id').length-6)];if(layer.opacity>0)$(group).attr("fill-opacity",layer.opacity);else $(group).attr("stroke-width",2*(1/reader.zoom.cur));});toggleMenuItem('showLayersLink',false);reader.allLayers=true;}
function hideAllLayers(){$(reader.canvas.layerGroup).find("g").each(function(index,group){$(group).attr("stroke-width",0);$(group).attr("fill-opacity",0);});toggleMenuItem('showLayersLink',true);reader.allLayers=false;}
function highlightSourceLayer(){if(reader.fromLayer==null)return;highlightLayer(reader.fromLayer);}
function highlightLayer(id){hideAllLayers();$('#'+id+'_group').attr("stroke-width",3*(1/reader.zoom.cur)).fadeTo(1,0).delay(250).fadeTo(1,1).delay(250).fadeTo(1,0).delay(250).fadeTo(1,1).delay(250).fadeTo(1,0).delay(250).fadeTo(1,1).delay(250).fadeTo(1,0).delay(250).fadeTo(1,1);}
function displayObjectMetadata(object){if(object==null||object.type!='object')return;for(var i=1;i<reader.project.sortedFields.length;i++)
if(object.md[reader.lang]!=null&&object.md[reader.lang][reader.project.sortedFields[i]]!=null&&object.md[reader.lang][reader.project.sortedFields[i]].length>0){$("#"+reader.project.sortedFields[i]+"_field").show();var objMetadata=object.md[reader.lang][[reader.project.sortedFields[i]]];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){objMetadata=highlightWord(objMetadata,term);});$("#"+reader.project.sortedFields[i]+"_value").html(objMetadata);}else $("#"+reader.project.sortedFields[i]+"_field").hide();if(object.md[reader.lang]!=null&&object.md[reader.lang][reader.project.sortedFields[0]]!=null&&object.md[reader.lang][reader.project.sortedFields[0]].length>0){$("#objectannotation_field").show();var objAnnotation=object.md[reader.lang][reader.project.sortedFields[0]];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){objAnnotation=highlightWord(objAnnotation,term);});$("#objectannotation_value").html(objAnnotation);}else $("#objectannotation_field").hide();}
function displayViewMetadata(view){if(view==null||view.type!='view')return;if(view.title[reader.lang]!=null&&view.title[reader.lang].length>0){$("#viewtitle_field").show();var viewTitle=view.title[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){viewTitle=highlightWord(viewTitle,term);});$("#viewtitle_value").html(viewTitle);}else $("#viewtitle_field").hide();if(view.source[reader.lang]!=null&&view.source[reader.lang].length>0){$("#viewsource_field").show();var viewSource=view.source[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){viewSource=highlightWord(viewSource,term);});$("#viewsource_value").html(viewSource);}else $("#viewsource_field").hide();if(view.annotation[reader.lang]!=null&&view.annotation[reader.lang].length>0){$("#viewannotation_field").show();var viewAnnotation=view.annotation[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){viewAnnotation=highlightWord(viewAnnotation,term);});$("#viewannotation_value").html(viewAnnotation);}else $("#viewannotation_field").hide();}
function displayLayerMetadata(layer){if(layer==null||layer.type!='layer')return;if(layer.annotation[reader.lang]!=null&&layer.annotation[reader.lang].length>0){$("#layerannotation_field").show();var layerAnnotation=layer.annotation[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){layerAnnotation=highlightWord(layerAnnotation,term);});$("#layerannotation_value").html(layerAnnotation);}else $("#layerannotation_field").hide();}
function displayInscription(inscription){$('#inscriptionContent').html('');if(inscription==null||inscription.type!='inscription')return;var insContent=inscription.content[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){insContent=highlightWord(insContent,term);});$('#inscriptionContent').html(insContent);showTab(2);}
function findHigherRes(view,href,width,height){if(view==null||view.type!='view')return;var ref=(href==null)?$("#canvasImage").attr('href'):href;var curRes=null;for(var i=0;i<view.files['images'].length;i++)
if(view.files['images'][i].href==ref)curRes=view.files['images'][i];if(curRes==null)return;var curWidth=(width==null)?Math.round(view.files['original'].width*reader.zoom.cur):width;var curHeight=(height==null)?Math.round(view.files['original'].height*reader.zoom.cur):height;if((curWidth*curHeight)>(curRes.width*curRes.height)){var newRes=null;for(var i=0;i<view.files['images'].length;i++)
if((view.files['images'][i].width*view.files['images'][i].height)>=(curWidth*curHeight)){newRes=view.files['images'][i];break;}
if(newRes==null)newRes=view.files['original'];if(newRes.href!=ref)return newRes;}
return null;}
function loadHiResIfNeeded(){var view=reader.project.items[reader.viewID];var hiRes=findHigherRes(view);if(hiRes==null)return;if(hiRes.href!=view.files['images'][0].href)setImageLoadingIndicator(true);var newImg=new Image();newImg.src=hiRes.href;newImg.onload=function(){$("#canvasImage").attr('href',hiRes.href);$("#canvasImage").show();setImageLoadingIndicator(false);};}
function setMenuItem(id,ref,enabled){if(enabled){$('#'+id).parent().removeClass("disabled");$('#'+id).attr("href",ref);}else{$('#'+id).parent().addClass("disabled");$('#'+id).attr("href",location.hash);}}
function toggleMenuItem(id,state){if(state){$('#'+id+'_ON').parent().show();$('#'+id+'_OFF').parent().hide();}else{$('#'+id+'_ON').parent().hide();$('#'+id+'_OFF').parent().show();}}
function setMenuState(){var displayMenuEnabled=false;if(reader.mode=='regular'&&getObject(reader.project.items[reader.load])!=null)displayMenuEnabled=true;setMenuItem('wholePictureLink',"javascript:scaleImageTo(reader.zoom.image);",displayMenuEnabled);setMenuItem('wholeWindowLink',"javascript:scaleImageTo(reader.zoom.window);",displayMenuEnabled);setMenuItem('bestResolutionLink',"javascript:scaleImageTo(reader.zoom.full);",displayMenuEnabled);setZoomGUI(displayMenuEnabled,displayMenuEnabled);setMenuItem('showLayersLink_ON',"javascript:highlightAllLayers();",displayMenuEnabled&&(Object.keys(reader.project.items[reader.viewID].layers).length>0));setMenuItem('showLayersLink_OFF',"javascript:hideAllLayers();",displayMenuEnabled&&(Object.keys(reader.project.items[reader.viewID].layers).length>0));toggleMenuItem('showLayersLink',true);reader.allLayers=false;if(displayMenuEnabled&&(Object.keys(reader.project.items[reader.viewID].layers).length>0)&&reader.prefs['VIEW_SHOW_LAYER']=='true'){toggleMenuItem('showLayersLink',false);highlightAllLayers();}
setMenuItem('targetLayerLink_ON',"javascript:highlightSourceLayer();",displayMenuEnabled&&(reader.fromLayer!=null));toggleMenuItem('targetLayerLink',true);setMenuItem('sitesLink',"#"+reader.load+"/sites",true);setMenuItem('refsLink',"#"+reader.load+"/refs",true);if(getObject(reader.project.items[reader.load])!=null&&Object.keys(getObject(reader.project.items[reader.load]).siblings).length>1)
setMenuItem('allLink',"#"+reader.load+"/all",true);else setMenuItem('allLink',"#"+reader.load+"/all",false);if($('#lighttableView').is(':visible')){$('#displayMenu li').each(function(index,item){if(!$(item).hasClass('disabled'))$(item).addClass('disabled');});setMenuItem('sitesLink',"#"+reader.load+"/sites",(reader.table.id!=null));setMenuItem('refsLink',"#"+reader.load+"/refs",(reader.table.id!=null));setMenuItem('allLink',"#"+reader.load+"/all",false);setMenuItem('addViewLink','javascript:addViewToLightTable();',false);toggleMenuItem('showLitaLink',false);}else{if(reader.viewID!=null)setMenuItem('addViewLink','javascript:addViewToLightTable();',true);else setMenuItem('addViewLink','javascript:addViewToLightTable();',false);toggleMenuItem('showLitaLink',true);setMenuItem('showViewLink','javascript:void(0);',false);setMenuItem('duplicateLink','javascript:void(0);',false);setMenuItem('removeLink','javascript:void(0);',false);setMenuItem('fitFrameLink','javascript:void(0);',false);setMenuItem('fitToThumbLink','javascript:void(0);',false);toggleMenuItem('addAnnotationLink',true);setMenuItem('addAnnotationLink_ON','javascript:void(0);',false);setMenuItem('addAnnotationLink_OFF','javascript:void(0);',false);setMenuItem('insertLinkLink','javascript:void(0);',false);setMenuItem('nameTableLink','javascript:void(0);',false);setMenuItem('saveTableLink','javascript:void(0);',false);setMenuItem('newTableLink','javascript:void(0);',false);setMenuItem('copyXMLLink','javascript:void(0);',false);}}
function setGUIMode(mode){var modeDIVs=['#canvas','#textView','#groupView','#lighttableView'];for(var i=0;i<modeDIVs.length;i++)$(modeDIVs[i]).hide();$(modeDIVs[mode]).show();if(mode==3){$('#sidebar').hide();$('#tabs').hide();$('#info').css('background-color',reader.prefs['LITA_INFOLINE_COLOR']);$('#info').css('color',reader.prefs['LITA_INFO_COLOR']);$('#info').css('font-family',reader.prefs['LITA_INFO_FONT']);$('#info').css('font-size',reader.prefs['LITA_INFO_SIZE']+'px');}else{$('#sidebar').show();$('#tabs').show();$('#info').css("background-color",reader.prefs['INFOLINE_COLOR']);$('#info').css("color",reader.prefs['MAINTEXT_COLOR']);$('#info').css('font-family',reader.prefs['MAINTEXT_FONT']);$('#info').css('font-size',reader.prefs['MAINTEXT_SIZE']+'px');}}
function loadViewFileData(element,view,ref){element.attr('href',ref);}
function setGUI(forceLoad){if(!forceLoad)forceLoad=false;var guiMode=0;var item=reader.project.items[reader.load];var loadViewFile=false;var list=null;var newViewID=null;if(getObject(item)!=null)if(item.type=='view')newViewID=item.id;else
if(item.type=='layer')newViewID=item.parent.id;else newViewID=getObject(item).defaultViewID;if(getObject(item)==null||reader.mode!='regular')guiMode=2;else if((reader.viewID==null||getObject(reader.project.items[reader.viewID]).id!=getObject(item).id)&&reader.mode=='regular'||(reader.mode=='regular'&&reader.viewID!=newViewID))
loadViewFile=true;if(item.type=='text'&&reader.mode=='regular')guiMode=1;if(item.type=='lita'&&reader.mode=='regular')guiMode=3;if(item.type=='url'){location.href=item.url;return;}
setGUIMode(guiMode);for(var i=0;i<reader.project.sortedFields.length;i++)$("#"+reader.project.sortedFields[i]+"_field").hide();$("#objectannotation_field").hide();$("#viewannotation_field").hide();$("#groupannotation_field").hide();$("#layerannotation_field").hide();$("#viewtitle_field").hide();$("#viewsource_field").hide();displayInscription(item);$('#canvasTooltip').hide();$('.context-menu-list').hide();reader.viewID=newViewID;switch(guiMode){case 0:displayObjectMetadata(getObject(item));displayViewMetadata(reader.project.items[reader.viewID]);if(item.type=='layer')displayLayerMetadata(item);if(item.type=='object')showTab(reader.prefs['TABS_STANDARD']);break;case 1:reader.viewID=null;var textContent=item.content[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){textContent=highlightWord(textContent,term);});$('#textContent').html(textContent);break;case 2:if(reader.mode=='refs'){if(item.refs!=null)list=item.refs;else list=reader.project.items[reader.viewID].refs;}else if(reader.mode=='sites'){if(item.sites!=null)list=item.sites;else list=reader.project.items[reader.viewID].sites;}else if(reader.mode=='all')list=getObject(item).siblings;else{list=item.members;if(item.annotation[reader.lang]!=null&&item.annotation[reader.lang].length>0){$("#groupannotation_field").show();var groupAnnotation=item.annotation[reader.lang];if(reader.fromSearch)
$(reader.search.resultTerms).each(function(index,term){groupAnnotation=highlightWord(groupAnnotation,term);});$("#groupannotation_value").html(groupAnnotation);}}
displayContentList(list);reader.viewID=null;break;case 3:reader.viewID=null;reader.table=JSON.parse(JSON.stringify(item));displayLightTable();break;}
$('#infotext').text('');if(reader.mode=='regular')
if(item.type=='object'||item.type=='view'||item.type=='layer'){var infotext='';var obj=getObject(item);if(obj.md[reader.lang]!=null){for(var i=1;i<=reader.prefs['INFOLINE_METADATA_NUM'];i++){var mdText=obj.md[reader.lang][[reader.project.sortedFields[i]]];if(mdText!=null&&mdText.length>0){if(i>1)infotext+='&nbsp;&nbsp;&ndash;&nbsp;&nbsp;';infotext+=mdText;}}
if(reader.prefs['INFOLINE_METADATA_VIEW']&&reader.project.items[reader.viewID]!=null&&reader.project.items[reader.viewID].title[reader.lang]!=null&&reader.project.items[reader.viewID].title[reader.lang].length>0){if(infotext.length>0)infotext+='&nbsp;&nbsp;&ndash;&nbsp;&nbsp;';infotext+=reader.project.items[reader.viewID].title[reader.lang];}}
$('#infotext').html(infotext);}
else if(item.type=='inscription')$('#infotext').text(reader.project.items[reader.viewID].title[reader.lang]);else if(item.type=='lita')$('#infotext').text(reader.strings[reader.lang]['INFOLINE_LITA']+' '+item.title[reader.lang]);else $('#infotext').text(item.title[reader.lang]);if(loadViewFile||(forceLoad&&guiMode==0)){if(!forceLoad)reader.fromLayer=null;var view=reader.project.items[reader.viewID];$('#canvasLayerGroup > g').remove();$("#canvasImage").attr('width',view.files['original'].width);$("#canvasImage").attr('height',view.files['original'].height);loadViewFileData($("#canvasImage"),view,view.files['images'][0].href);$('#canvas').scrollTop(0);$('#canvas').scrollLeft(0);calcImageScales();scaleImageTo(reader.zoom.image);$(view.sortedLayers).each(function(index,layer){var layerID=layer.id;var sWidth=0;var svgLayer=reader.canvas.svg.group(reader.canvas.layerGroup,layer.id+"_group",{class:'layerContextMenu',strokeWidth:sWidth*(1/reader.zoom.cur),fill:layer.color,stroke:layer.color,fillOpacity:0.0});var tooltipDiv='';if(layer.title[reader.lang]!=null&&layer.title[reader.lang].length>0)tooltipDiv+=layer.title[reader.lang]+"<br />";if(layer.annotation[reader.lang]!=null&&layer.annotation[reader.lang].length>0)tooltipDiv+="<br />"+layer.annotation[reader.lang];if(tooltipDiv.length>0)$(svgLayer).tooltip({tip:"#canvasTooltip",relative:true,predelay:300,delay:300,position:'center left',onBeforeShow:function(tt,pos){$('#canvasTooltip .tooltipContent').html(tooltipDiv);$(tt.target).tooltip().getConf().offset[1]=Math.round(reader.pageX-pos.left)+64;$(tt.currentTarget.getTip()).css("cursor","move");},onBeforeHide:function(tt,pos){tt.currentTarget.getConf().offset[1]=0;},onShow:function(tt,pos){if(($(window).width()-($('#canvasTooltip').position().left+$('#canvasTooltip').width()))<0)
$('#canvasTooltip').css('left',$(window).width()-$('#canvasTooltip').width()-5);if(($(window).height()-($('#canvasTooltip').position().top+$('#canvasTooltip').height()+reader.zoom.yOffset))<0)
$('#canvasTooltip').css('top',$(window).height()-$('#canvasTooltip').height()-reader.zoom.yOffset-5);this.getTip().draggable({containment:'#canvas'});},onHide:function(tt,pos){try{this.getTip().draggable("destroy");}catch(e){}}});$(svgLayer).hover(function(ev,source){var layer=reader.project.items[$(ev.currentTarget).attr('id').substring(0,$(ev.currentTarget).attr('id').length-6)];if(reader.fromLayer!=layer.id&&!reader.allLayers){if(layer.opacity>0)ev.currentTarget.setAttribute("fill-opacity",layer.opacity);else ev.currentTarget.setAttribute("stroke-width",2*(1/reader.zoom.cur));}},function(ev,source){var layer=reader.project.items[$(ev.currentTarget).attr('id').substring(0,$(ev.currentTarget).attr('id').length-6)];if(reader.fromLayer!=layer.id&&!reader.allLayers){if(layer.opacity>0)ev.currentTarget.setAttribute("fill-opacity",0.0);else ev.currentTarget.setAttribute("stroke-width",0);}});if(layer.ref!=null&&layer.ref.length>0){$(svgLayer).css("cursor","pointer");$(svgLayer).click(function(ev){var layer=reader.project.items[ev.currentTarget.id.substring(0,ev.currentTarget.id.length-6)];if(layer!=null){reader.fromLayer=layer.id;if(!checkExternalLink('#'+layer.ref+'/'))location.hash=layer.ref+"/";}
ev.preventDefault();});}
var scaledPath='';for(index in view.layers[layerID].polygons){var polygon=layer.polygons[view.layers[layerID].polygons.length-1-index];for(var a=0;a<polygon.split(' ').length;a++){var coord=polygon.split(' ')[a];var x=parseFloat(coord.split(',')[0]);var y=parseFloat(coord.split(',')[1]);x=x*reader.zoom.width;y=y*reader.zoom.height;if(a==0)scaledPath+='M '+x+" "+y+" ";else scaledPath+='L '+x+" "+y+" ";}}
if(scaledPath!='')reader.canvas.svg.path(svgLayer,scaledPath+' Z',{fillRule:'evenodd'});});}
if(item.type=='layer'){reader.fromLayer=item.id;if(reader.prefs['LAYER_CENTER']!=null&&reader.prefs['LAYER_CENTER']=='true'){var svgLayer=$('#'+item.id+"_group")[0];var rect=svgLayer.getBoundingClientRect();var factorWidth=$(window).width()/(1.2*(rect.width/(reader.zoom.width*reader.zoom.cur))*reader.zoom.width);var factorHeight=$(window).height()/(1.2*(rect.height/(reader.zoom.height*reader.zoom.cur))*reader.zoom.height);var factor=Math.min(Math.min(factorWidth,factorHeight),reader.zoom.full);scaleImageTo(factor);var scrollX=($('#canvas').scrollLeft()+svgLayer.getBoundingClientRect().left+(svgLayer.getBoundingClientRect().width/2))-($(window).width()/2)+(reader.zoom.xOffset/2);var scrollY=($('#canvas').scrollTop()+svgLayer.getBoundingClientRect().top+(svgLayer.getBoundingClientRect().height/2))-($(window).height()/2)-(reader.zoom.yOffset/2);$('#canvas').scrollTop(scrollY);$('#canvas').scrollLeft(scrollX);}
highlightLayer(item.id);}
setMenuState();setLoadingIndicator(false);if(reader.fromSearch){var infotext=$('#infotext').text();$(reader.search.resultTerms).each(function(index,term){infotext=highlightWord(infotext,term);});$('#infotext').html(infotext);}
reader.fromSearch=false;scanExternalLinks();$("#loadingpanel").css('display','none');}